<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sportsbook - Svidhaus Arena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root[data-theme="dark"] {
            --bg: #0f0f0f; --sidebar-bg: #1a1a1a; --card-bg: #1e1e1e;
            --card-border: #2a2a2a; --text-primary: #ffffff; --text-secondary: #888888;
            --text-muted: #555555; --accent: #22c55e; --accent-hover: #16a34a;
            --accent-dim: rgba(34,197,94,0.1); --danger: #ef4444;
            --input-bg: #2a2a2a; --input-border: #333333;
            --hover-bg: #252525; --divider: #2a2a2a; --modal-bg: #1a1a1a;
            --filter-bg: #252525; --filter-active: #22c55e;
            --game-card-bg: #1e1e1e; --bet-btn-bg: #2a2a2a; --bet-btn-border: #3a3a3a;
        }
        :root[data-theme="light"] {
            --bg: #f4f6f9; --sidebar-bg: #ffffff; --card-bg: #ffffff;
            --card-border: #e5e7eb; --text-primary: #111827; --text-secondary: #6b7280;
            --text-muted: #9ca3af; --accent: #16a34a; --accent-hover: #15803d;
            --accent-dim: rgba(22,163,74,0.08); --danger: #dc2626;
            --input-bg: #f9fafb; --input-border: #d1d5db;
            --hover-bg: #f3f4f6; --divider: #e5e7eb; --modal-bg: #ffffff;
            --filter-bg: #f0f0f0; --filter-active: #16a34a;
            --game-card-bg: #ffffff; --bet-btn-bg: #f8f9fa; --bet-btn-border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text-primary);
            min-height: 100vh; display: flex; transition: background 0.3s, color 0.3s;
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar {
            width: 240px; background: var(--sidebar-bg); border-right: 1px solid var(--divider);
            display: flex; flex-direction: column; padding: 24px 0;
            position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
            transition: background 0.3s, border-color 0.3s, transform 0.3s;
        }
        .sidebar-logo { padding: 0 24px 28px; border-bottom: 1px solid var(--divider); margin-bottom: 16px; }
        .sidebar-logo h1 { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .sidebar-logo span { font-size: 12px; color: var(--text-secondary); }
        .sidebar-section { padding: 0 12px; margin-bottom: 8px; }
        .sidebar-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; padding: 0 12px; margin-bottom: 4px; }
        .sidebar-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 12px;
            border-radius: 8px; font-size: 14px; font-weight: 500; color: var(--text-secondary);
            cursor: pointer; text-decoration: none; transition: background 0.15s, color 0.15s; margin-bottom: 2px;
        }
        .sidebar-item:hover { background: var(--hover-bg); color: var(--text-primary); }
        .sidebar-item.active { background: var(--accent-dim); color: var(--accent); }
        .sidebar-item .icon { font-size: 16px; width: 20px; text-align: center; }
        .soon-badge { margin-left: auto; background: var(--card-border); color: var(--text-muted); font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 10px; }
        .sidebar-bottom { margin-top: auto; padding: 16px 12px; border-top: 1px solid var(--divider); }

        /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
        .main { margin-left: 240px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
        .topbar {
            background: var(--sidebar-bg); border-bottom: 1px solid var(--divider);
            padding: 0 32px; height: 64px; display: flex; align-items: center;
            justify-content: space-between; position: sticky; top: 0; z-index: 50;
            transition: background 0.3s, border-color 0.3s;
        }
        .topbar-left h2 { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .topbar-right { display: flex; align-items: center; gap: 12px; }
        .theme-toggle {
            width: 36px; height: 36px; border-radius: 8px; background: var(--hover-bg);
            border: 1px solid var(--card-border); font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--accent-dim); border-color: var(--accent); }
        .mobile-menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 22px; cursor: pointer; }

        /* ‚îÄ‚îÄ Nav Toggle (Place Bets / My Bets) ‚îÄ‚îÄ */
        .view-toggle {
            display: flex; gap: 4px; background: var(--hover-bg); border: 1px solid var(--card-border);
            padding: 3px; border-radius: 8px;
        }
        .view-toggle button {
            background: transparent; color: var(--text-secondary); border: none;
            padding: 6px 14px; border-radius: 6px; cursor: pointer;
            font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        .view-toggle button.active { background: var(--accent); color: white; }

        /* ‚îÄ‚îÄ Sync status ‚îÄ‚îÄ */
        .sync-info { display: flex; align-items: center; gap: 10px; }
        .sync-time-text { font-size: 12px; color: var(--text-muted); }
        .sync-btn {
            background: var(--accent); color: white; border: none;
            padding: 7px 14px; border-radius: 7px; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .sync-btn:hover { background: var(--accent-hover); }
        .sync-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
        .content { padding: 24px 32px; flex: 1; }

        /* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
        .filters-panel {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 16px 20px; margin-bottom: 20px;
            transition: background 0.3s, border-color 0.3s;
        }
        .filter-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .filter-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-tab {
            padding: 7px 16px; background: var(--hover-bg); border: 1px solid var(--card-border);
            border-radius: 7px; cursor: pointer; font-size: 13px; font-weight: 500;
            color: var(--text-secondary); transition: all 0.2s;
        }
        .filter-tab:hover { border-color: var(--accent); color: var(--text-primary); }
        .filter-tab.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

        .league-filter-wrap { margin-top: 12px; display: none; }
        .league-filters { display: flex; gap: 6px; flex-wrap: wrap; padding-top: 6px; }
        .league-filter {
            padding: 5px 12px; background: var(--hover-bg); border: 1px solid var(--card-border);
            border-radius: 6px; cursor: pointer; font-size: 12px; color: var(--text-secondary);
            transition: all 0.2s;
        }
        .league-filter:hover { border-color: var(--accent); }
        .league-filter.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

        /* ‚îÄ‚îÄ Betting Layout ‚îÄ‚îÄ */
        .betting-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
        }

        /* ‚îÄ‚îÄ Games Section ‚îÄ‚îÄ */
        .games-section {
            display: flex; flex-direction: column; gap: 0;
        }

        .sport-group { margin-bottom: 24px; }
        .sport-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; background: var(--hover-bg); border: 1px solid var(--card-border);
            border-radius: 8px; margin-bottom: 12px;
            font-weight: 600; font-size: 14px; color: var(--text-primary);
        }
        .sport-header span:last-child { font-size: 12px; color: var(--text-muted); font-weight: 400; }

        .game-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 10px; padding: 16px; margin-bottom: 10px;
            transition: border-color 0.2s, background 0.3s;
        }
        .game-card:hover { border-color: var(--accent); }

        .game-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 14px; padding-bottom: 12px; border-bottom: 1px solid var(--divider);
        }
        .teams { flex: 1; }
        .team { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 4px 0; }
        .game-time { font-size: 12px; color: var(--text-muted); text-align: right; white-space: nowrap; }

        .betting-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .bet-type-group { display: flex; flex-direction: column; gap: 6px; }
        .bet-type-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }

        .bet-button {
            background: var(--bet-btn-bg); border: 1px solid var(--bet-btn-border);
            padding: 10px 8px; border-radius: 7px; cursor: pointer;
            font-size: 12px; color: var(--text-primary); text-align: center;
            transition: all 0.15s;
        }
        .bet-button:hover:not(:disabled) { border-color: var(--accent); background: var(--accent-dim); }
        .bet-button.selected { background: var(--accent); color: white; border-color: var(--accent); }
        .bet-button:disabled { opacity: 0.4; cursor: not-allowed; }
        .bet-button .odds { display: block; font-weight: 700; font-size: 14px; margin-top: 2px; }
        .bet-button .point { font-size: 11px; color: var(--text-muted); }
        .bet-button.selected .point { color: rgba(255,255,255,0.7); }

        /* ‚îÄ‚îÄ Bet Slip ‚îÄ‚îÄ */
        .bet-slip {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 20px;
            position: sticky; top: 80px; align-self: flex-start;
            transition: background 0.3s, border-color 0.3s;
        }
        .bet-slip-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; }
        .bet-slip-empty {
            text-align: center; padding: 32px 16px;
            color: var(--text-muted); font-size: 13px;
        }
        .bet-slip-items { margin-bottom: 16px; }
        .parlay-badge {
            background: var(--accent-dim); color: var(--accent); border: 1px solid var(--accent);
            padding: 6px 12px; border-radius: 7px; font-size: 12px; font-weight: 700;
            text-align: center; margin-bottom: 12px;
        }
        .slip-item {
            background: var(--hover-bg); border: 1px solid var(--card-border);
            border-radius: 8px; padding: 12px; margin-bottom: 8px; position: relative;
        }
        .slip-item .remove-btn {
            position: absolute; top: 8px; right: 8px;
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; font-size: 16px; padding: 0 4px; line-height: 1;
        }
        .slip-item .remove-btn:hover { color: var(--danger); }
        .slip-item .matchup { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .slip-item .selection { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .slip-item .odds-display { font-size: 13px; color: var(--accent); font-weight: 600; margin-top: 3px; }

        .slip-summary { border-top: 1px solid var(--divider); padding-top: 14px; }
        .stake-group { margin-bottom: 12px; }
        .stake-group label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .stake-group input {
            width: 100%; padding: 9px 12px; background: var(--input-bg);
            border: 1px solid var(--input-border); border-radius: 7px;
            font-size: 15px; color: var(--text-primary); outline: none;
            transition: border-color 0.2s;
        }
        .stake-group input:focus { border-color: var(--accent); }
        .payout-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 12px; background: var(--hover-bg); border-radius: 7px;
            margin-bottom: 12px;
        }
        .payout-row .label { font-size: 13px; color: var(--text-secondary); }
        .payout-row .value { font-size: 16px; font-weight: 700; color: var(--accent); }
        .place-bet-btn {
            width: 100%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 8px; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: background 0.2s;
        }
        .place-bet-btn:hover { background: var(--accent-hover); }
        .place-bet-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ‚îÄ‚îÄ My Bets View ‚îÄ‚îÄ */
        .my-bets-content { max-width: 860px; }
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 14px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 18px; text-align: center;
            transition: background 0.3s, border-color 0.3s;
        }
        .stat-card .s-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .stat-card .s-value { font-size: 28px; font-weight: 700; color: var(--accent); }
        .stat-card .s-sub { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .stat-card.profit-pos .s-value { color: var(--accent); }
        .stat-card.profit-neg .s-value { color: var(--danger); }

        .bets-panel { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 22px; }
        .bets-panel h3 { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px; }

        .bet-card {
            background: var(--hover-bg); border: 1px solid var(--card-border);
            border-left: 3px solid var(--text-muted);
            border-radius: 8px; padding: 14px; margin-bottom: 12px;
        }
        .bet-card.won { border-left-color: var(--accent); }
        .bet-card.lost { border-left-color: var(--danger); }
        .bet-card.push { border-left-color: #f59e0b; }

        .bet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .bet-type-badge { font-size: 12px; color: var(--text-muted); font-weight: 600; }
        .bet-status {
            padding: 3px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 700; text-transform: uppercase;
        }
        .bet-status.pending { background: var(--accent-dim); color: var(--accent); }
        .bet-status.won { background: var(--accent-dim); color: var(--accent); }
        .bet-status.lost { background: rgba(239,68,68,0.1); color: var(--danger); }
        .bet-status.push { background: rgba(245,158,11,0.1); color: #f59e0b; }

        .pick-item {
            font-size: 13px; color: var(--text-secondary); padding: 7px 0;
            border-bottom: 1px solid var(--divider);
            display: flex; align-items: center; gap: 8px;
        }
        .pick-item:last-child { border-bottom: none; }
        .pick-result {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 11px; flex-shrink: 0; color: white;
        }
        .pick-result.won { background: var(--accent); }
        .pick-result.lost { background: var(--danger); }
        .pick-result.push { background: #f59e0b; }
        .pick-result.pending { background: var(--text-muted); }

        .bet-amount {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--divider);
            font-size: 13px;
        }
        .bet-amount .stake { color: var(--text-muted); }
        .bet-amount .payout { font-weight: 600; color: var(--text-primary); }
        .bet-amount .payout.won { color: var(--accent); }
        .bet-date { font-size: 11px; color: var(--text-muted); margin-top: 6px; }

        /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
        .toast {
            position: fixed; bottom: 24px; left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: var(--card-bg); border: 1px solid var(--card-border);
            color: var(--text-primary); padding: 12px 20px;
            border-radius: 10px; font-size: 13px; font-weight: 500;
            display: none; z-index: 2000; box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        .toast.show { display: block; animation: toastIn 0.3s ease forwards; }
        @keyframes toastIn { to { transform: translateX(-50%) translateY(0); opacity: 1; } }

        /* ‚îÄ‚îÄ Loading/Error ‚îÄ‚îÄ */
        .loading { text-align: center; padding: 48px 20px; color: var(--text-muted); font-size: 14px; }
        .error-box {
            background: rgba(239,68,68,0.1); border: 1px solid var(--danger);
            color: var(--danger); padding: 14px 16px; border-radius: 8px;
            font-size: 13px; margin-bottom: 16px;
        }

        /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .topbar { padding: 0 16px; }
            .content { padding: 16px; }
            .mobile-menu-btn { display: block; }
            .betting-layout { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .sync-time-text { display: none; }

            .bet-slip {
                position: fixed; bottom: 0; left: 0; right: 0;
                border-radius: 20px 20px 0 0; z-index: 200;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
                max-height: 65vh; overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            .games-section { padding-bottom: 280px; }
            .betting-options { grid-template-columns: 1fr; gap: 10px; }
            .bet-type-group {
                border: 1px solid var(--card-border); padding: 10px; border-radius: 8px;
            }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .view-toggle button { padding: 6px 10px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h1>Svidhaus Arena</h1>
            <span>Gaming Hub</span>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-label">Menu</div>
            <a href="/" class="sidebar-item"><span class="icon">‚äû</span> Dashboard</a>
            <a href="/profile" class="sidebar-item"><span class="icon">üë§</span> Profile</a>
            <a href="/links" class="sidebar-item"><span class="icon">üîó</span> Links</a>
        </div>
        <div class="sidebar-section" style="margin-top:12px;">
            <div class="sidebar-label">Games</div>
            <a href="/trivia" class="sidebar-item"><span class="icon">ü§ì</span> Trivia</a>
            <a href="/wordle" class="sidebar-item"><span class="icon">üü©</span> Wordle</a>
            <a href="/sportsbook" class="sidebar-item active"><span class="icon">üèà</span> Sportsbook</a>
            <a href="/movies" class="sidebar-item"><span class="icon">üé¨</span> Movies &amp; TV</a>
            <div class="sidebar-item" style="cursor:default;opacity:0.5;"><span class="icon">ü§º</span> Wrestling<span class="soon-badge">Soon</span></div>
        </div>
        <div class="sidebar-bottom">
            <button class="sidebar-item" onclick="logout()" style="background:none;border:none;text-align:left;width:100%;color:var(--danger);cursor:pointer;">
                <span class="icon">‚Ü©</span> Logout
            </button>
        </div>
    </aside>

    <div class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <div class="topbar-left"><h2>Sportsbook</h2></div>
            </div>
            <div class="topbar-right">
                <div class="view-toggle">
                    <button class="active" onclick="showView('betting')">Place Bets</button>
                    <button onclick="showView('mybets')">My Bets</button>
                </div>
                <div class="sync-info">
                    <span class="sync-time-text" id="sync-time">Loading...</span>
                    <button class="sync-btn" id="sync-btn" onclick="syncOdds()">üîÑ Get Odds</button>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è</button>
            </div>
        </div>

        <div class="content">

            <!-- Betting View -->
            <div id="betting-view">
                <div class="filters-panel">
                    <div class="filter-label">Sport Category</div>
                    <div class="filter-tabs" id="category-tabs">
                        <button class="filter-tab" onclick="filterCategory('today')">üìÖ Games Today</button>
                        <button class="filter-tab" onclick="filterCategory('football')">üèà Football</button>
                        <button class="filter-tab" onclick="filterCategory('basketball')">üèÄ Basketball</button>
                        <button class="filter-tab" onclick="filterCategory('baseball')">‚öæ Baseball</button>
                        <button class="filter-tab" onclick="filterCategory('hockey')">üèí Hockey</button>
                        <button class="filter-tab" onclick="filterCategory('soccer')">‚öΩ Soccer</button>
                    </div>
                    <div id="league-filter-wrap" class="league-filter-wrap">
                        <div class="filter-label" style="margin-top:10px;">League</div>
                        <div class="league-filters" id="league-buttons"></div>
                    </div>
                </div>

                <div class="betting-layout">
                    <div class="games-section" id="games-container">
                        <div class="loading">Loading games...</div>
                    </div>

                    <div class="bet-slip">
                        <div class="bet-slip-title">Bet Slip</div>
                        <div id="bet-slip-content">
                            <div class="bet-slip-empty">
                                <p>Select bets to get started</p>
                                <p style="margin-top:8px;font-size:12px;">Add multiple picks for a parlay!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Bets View -->
            <div id="mybets-view" style="display:none;">
                <div class="my-bets-content">
                    <div class="stats-grid" id="stats-container">
                        <div class="loading" style="grid-column:1/-1;">Loading stats...</div>
                    </div>
                    <div class="bets-panel">
                        <h3>Recent Bets</h3>
                        <div id="bets-history">
                            <div class="loading">Loading bet history...</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = window.location.origin;
        let allGames = [];
        let allGamesRaw = [];
        let betSlip = [];
        let currentCategory = 'today';
        let currentLeague = null;

        // Theme
        function getTheme() { return localStorage.getItem('theme') || 'dark'; }
        function applyTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('theme-btn').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        function toggleTheme() {
            const n = getTheme() === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', n);
            applyTheme(n);
        }
        applyTheme(getTheme());

        function getToken() { return localStorage.getItem('access_token') || localStorage.getItem('token'); }
        function getUser() { try { return JSON.parse(localStorage.getItem('user')); } catch { return null; } }
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        function requireRole(...roles) {
            const u = getUser();
            if (!u) { window.location.href = '/login'; return false; }
            if (!roles.includes(u.role)) {
                document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);flex-direction:column;gap:16px;font-family:sans-serif;">
                    <div style="font-size:48px;">üîí</div>
                    <div style="font-size:20px;font-weight:700;color:var(--text-primary,#fff);">Access Restricted</div>
                    <div style="font-size:14px;color:var(--text-secondary,#888);text-align:center;max-width:320px;">This section requires a <strong>User</strong> account or higher. Contact an admin to upgrade your access.</div>
                    <a href="/" style="margin-top:8px;padding:10px 20px;background:#22c55e;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;">Back to Dashboard</a>
                </div>`;
                return false;
            }
            return true;
        }

        // League mapping
        const leagueNames = {
            'americanfootball_nfl': 'NFL', 'americanfootball_ncaaf': 'NCAA',
            'americanfootball_cfl': 'CFL', 'australianfootball_afl': 'AFL',
            'basketball_nba': 'NBA', 'basketball_ncaab': 'NCAA',
            'basketball_wnba': 'WNBA', 'basketball_euroleague': 'Euroleague',
            'baseball_mlb': 'MLB', 'baseball_kbo': 'KBO', 'baseball_npb': 'NPB',
            'icehockey_nhl': 'NHL', 'icehockey_ahl': 'AHL', 'icehockey_shl': 'SHL',
            'icehockey_allsvenskan': 'Allsvenskan', 'icehockey_liiga': 'Liiga',
            'soccer_epl': 'EPL', 'soccer_germany_bundesliga': 'Bundesliga',
            'soccer_spain_la_liga': 'La Liga', 'soccer_italy_serie_a': 'Serie A',
            'soccer_france_ligue_one': 'Ligue 1', 'soccer_brazil_campeonato': 'Brasileir√£o',
            'soccer_uefa_champs_league': 'Champions League', 'soccer_uefa_europa_league': 'Europa League'
        };

        async function loadGames(category = null) {
            try {
                const url = category && category !== 'today'
                    ? `${API_URL}/api/sports/today?category=${category}`
                    : `${API_URL}/api/sports/today`;
                const response = await fetch(url);
                const data = await response.json();
                allGamesRaw = data;
                allGames = data;
                if (category && category !== 'today') {
                    showLeagueFilters(category);
                } else {
                    hideLeagueFilters();
                }
                renderGames();
            } catch (error) {
                console.error('Error loading games:', error);
                document.getElementById('games-container').innerHTML =
                    '<div class="error-box">Failed to load games. Please try again later.</div>';
            }
        }

        function showLeagueFilters(category) {
            const wrap = document.getElementById('league-filter-wrap');
            const buttonsDiv = document.getElementById('league-buttons');
            const leagues = new Set();
            allGamesRaw.forEach(sg => { if (sg.category === category) leagues.add(sg.sport_key); });
            if (leagues.size > 1) {
                let html = '<button class="league-filter active" onclick="filterLeague(null)">All Leagues</button>';
                leagues.forEach(l => {
                    html += `<button class="league-filter" onclick="filterLeague('${l}')">${leagueNames[l] || l}</button>`;
                });
                buttonsDiv.innerHTML = html;
                wrap.style.display = 'block';
            } else {
                wrap.style.display = 'none';
            }
        }

        function hideLeagueFilters() {
            document.getElementById('league-filter-wrap').style.display = 'none';
            currentLeague = null;
        }

        function filterLeague(league) {
            currentLeague = league;
            document.querySelectorAll('.league-filter').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            allGames = league ? allGamesRaw.filter(sg => sg.sport_key === league) : allGamesRaw;
            renderGames();
        }

        function renderGames() {
            const container = document.getElementById('games-container');
            if (!allGames || allGames.length === 0) {
                container.innerHTML = '<div class="loading">No games available for this selection</div>';
                return;
            }
            let html = '';
            let totalGames = 0;
            allGames.forEach(sg => {
                if (sg.games && sg.games.length > 0) {
                    totalGames += sg.games.length;
                    html += `<div class="sport-group">
                        <div class="sport-header">
                            <span>${sg.sport_title}</span>
                            <span>${sg.games.length} games</span>
                        </div>`;
                    sg.games.forEach(game => { html += renderGameCard(game); });
                    html += '</div>';
                }
            });
            container.innerHTML = totalGames === 0 ? '<div class="loading">No games available</div>' : html;
        }

        function renderGameCard(game) {
            const commenceTime = new Date(game.commence_time);
            const timeStr = commenceTime.toLocaleString('en-US', {
                month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit',
                timeZone: 'America/New_York', timeZoneName: 'short'
            });
            const ml = game.moneyline || {};
            const sp = game.spreads || {};
            const tot = game.totals || {};
            return `
                <div class="game-card">
                    <div class="game-header">
                        <div class="teams">
                            <div class="team">${game.away_team}</div>
                            <div class="team">${game.home_team}</div>
                        </div>
                        <div class="game-time">${timeStr}</div>
                    </div>
                    <div class="betting-options">
                        <div class="bet-type-group">
                            <div class="bet-type-label">Moneyline</div>
                            ${ml.away ? `<button class="bet-button" onclick='addToBetSlip(${JSON.stringify({matchId:game.match_id,matchup:`${game.away_team} @ ${game.home_team}`,betType:"moneyline",selection:"away",team:game.away_team,odds:ml.away,sportKey:game.sport_key})})'>
                                <span>${game.away_team}</span><span class="odds">${ml.away>0?'+':''}${ml.away}</span></button>` : '<button class="bet-button" disabled>N/A</button>'}
                            ${ml.home ? `<button class="bet-button" onclick='addToBetSlip(${JSON.stringify({matchId:game.match_id,matchup:`${game.away_team} @ ${game.home_team}`,betType:"moneyline",selection:"home",team:game.home_team,odds:ml.home,sportKey:game.sport_key})})'>
                                <span>${game.home_team}</span><span class="odds">${ml.home>0?'+':''}${ml.home}</span></button>` : '<button class="bet-button" disabled>N/A</button>'}
                        </div>
                        <div class="bet-type-group">
                            <div class="bet-type-label">Spread</div>
                            ${sp.away ? `<button class="bet-button" onclick='addToBetSlip(${JSON.stringify({matchId:game.match_id,matchup:`${game.away_team} @ ${game.home_team}`,betType:"spread",selection:"away",team:game.away_team,odds:sp.away.odds,point:sp.away.point,sportKey:game.sport_key})})'>
                                <span class="point">${sp.away.point>0?'+':''}${sp.away.point}</span><span class="odds">${sp.away.odds>0?'+':''}${sp.away.odds}</span></button>` : '<button class="bet-button" disabled>N/A</button>'}
                            ${sp.home ? `<button class="bet-button" onclick='addToBetSlip(${JSON.stringify({matchId:game.match_id,matchup:`${game.away_team} @ ${game.home_team}`,betType:"spread",selection:"home",team:game.home_team,odds:sp.home.odds,point:sp.home.point,sportKey:game.sport_key})})'>
                                <span class="point">${sp.home.point>0?'+':''}${sp.home.point}</span><span class="odds">${sp.home.odds>0?'+':''}${sp.home.odds}</span></button>` : '<button class="bet-button" disabled>N/A</button>'}
                        </div>
                        <div class="bet-type-group">
                            <div class="bet-type-label">Total</div>
                            ${tot.over ? `<button class="bet-button" onclick='addToBetSlip(${JSON.stringify({matchId:game.match_id,matchup:`${game.away_team} @ ${game.home_team}`,betType:"total",selection:"over",team:"Over",odds:tot.over.odds,point:tot.over.point,sportKey:game.sport_key})})'>
                                <span class="point">O ${tot.over.point}</span><span class="odds">${tot.over.odds>0?'+':''}${tot.over.odds}</span></button>` : '<button class="bet-button" disabled>N/A</button>'}
                            ${tot.under ? `<button class="bet-button" onclick='addToBetSlip(${JSON.stringify({matchId:game.match_id,matchup:`${game.away_team} @ ${game.home_team}`,betType:"total",selection:"under",team:"Under",odds:tot.under.odds,point:tot.under.point,sportKey:game.sport_key})})'>
                                <span class="point">U ${tot.under.point}</span><span class="odds">${tot.under.odds>0?'+':''}${tot.under.odds}</span></button>` : '<button class="bet-button" disabled>N/A</button>'}
                        </div>
                    </div>
                </div>`;
        }

        function addToBetSlip(pick) {
            const existing = betSlip.findIndex(p => p.matchId === pick.matchId);
            if (existing >= 0) {
                betSlip[existing] = pick;
            } else {
                betSlip.push(pick);
            }
            renderBetSlip();
        }

        function removeFromBetSlip(index) {
            betSlip.splice(index, 1);
            renderBetSlip();
        }

        function renderBetSlip() {
            const container = document.getElementById('bet-slip-content');
            if (betSlip.length === 0) {
                container.innerHTML = `<div class="bet-slip-empty">
                    <p>Select bets to get started</p>
                    <p style="margin-top:8px;font-size:12px;">Add multiple picks for a parlay!</p>
                </div>`;
                return;
            }
            const isParlay = betSlip.length > 1;
            const stakeVal = document.getElementById('stake-input') ? parseInt(document.getElementById('stake-input').value) || 10 : 10;
            const payout = calculatePayout(betSlip, stakeVal);
            let html = '<div class="bet-slip-items">';
            if (isParlay) html += `<div class="parlay-badge">${betSlip.length}-Leg Parlay</div>`;
            betSlip.forEach((pick, i) => {
                const pointStr = pick.point !== undefined && pick.point !== null ? ` (${pick.point > 0 ? '+' : ''}${pick.point})` : '';
                html += `<div class="slip-item">
                    <button class="remove-btn" onclick="removeFromBetSlip(${i})">√ó</button>
                    <div class="matchup">${pick.matchup}</div>
                    <div class="selection">${pick.team}${pointStr}</div>
                    <div class="odds-display">${pick.odds > 0 ? '+' : ''}${pick.odds}</div>
                </div>`;
            });
            html += '</div>';
            html += `<div class="slip-summary">
                <div class="stake-group">
                    <label>Stake (points)</label>
                    <input type="number" id="stake-input" value="${stakeVal}" min="1" max="1000" onchange="renderBetSlip()">
                </div>
                <div class="payout-row">
                    <span class="label">Potential Payout</span>
                    <span class="value">${payout.toFixed(2)} pts</span>
                </div>
                <button class="place-bet-btn" onclick="placeBet()">Place Bet</button>
            </div>`;
            container.innerHTML = html;
        }

        function calculatePayout(picks, stake) {
            let odds = 1.0;
            picks.forEach(p => {
                odds *= p.odds > 0 ? (p.odds / 100) + 1 : (100 / Math.abs(p.odds)) + 1;
            });
            return stake * odds;
        }

        async function placeBet() {
            const stakeInput = document.getElementById('stake-input');
            const stake = parseInt(stakeInput ? stakeInput.value : 10) || 10;
            if (betSlip.length === 0) { showToast('Add at least one pick first'); return; }
            try {
                await fetch(`${API_URL}/api/sports/admin/sync-matches`, { method: 'POST' });
            } catch (e) { console.error('Sync error:', e); }
            const betRequest = {
                picks: betSlip.map(p => ({
                    match_id: p.matchId, bet_type: p.betType,
                    selection: p.selection, odds: p.odds, point: p.point || null
                })),
                stake
            };
            try {
                const response = await fetch(`${API_URL}/api/sports/bets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
                    body: JSON.stringify(betRequest)
                });
                if (response.ok) {
                    const result = await response.json();
                    showToast(`Bet placed! ID: ${result.id}`);
                    betSlip = [];
                    renderBetSlip();
                } else {
                    const error = await response.json();
                    showToast('Error: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error placing bet:', e);
                showToast('Failed to place bet. Please try again.');
            }
        }

        function filterCategory(category) {
            currentCategory = category;
            currentLeague = null;
            document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadGames(category === 'today' ? null : category);
        }

        async function loadSyncStatus() {
            try {
                const response = await fetch(`${API_URL}/api/sports/sync-status`);
                const data = await response.json();
                const el = document.getElementById('sync-time');
                if (data.status === 'never') {
                    el.textContent = '‚ö†Ô∏è No odds loaded';
                    el.style.color = 'var(--danger)';
                } else {
                    el.textContent = `Last sync: ${data.formatted_time}`;
                    el.style.color = '';
                }
            } catch (e) {
                document.getElementById('sync-time').textContent = 'Status unavailable';
            }
        }

        async function syncOdds() {
            const btn = document.getElementById('sync-btn');
            const orig = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Syncing...';
            showToast('Syncing odds from The Odds API...');
            try {
                const response = await fetch(`${API_URL}/api/sports/admin/sync-matches`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (response.ok) {
                    const result = await response.json();
                    showToast(`Sync complete! ${result.new_matches} new, ${result.updated_matches} updated`);
                    await loadSyncStatus();
                    await loadGames(currentCategory === 'today' ? null : currentCategory);
                } else if (response.status === 403) {
                    showToast('Admin access required');
                } else {
                    const error = await response.json();
                    showToast('Sync failed: ' + (error.detail || 'Unknown error'));
                }
            } catch (e) {
                showToast('Sync failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = orig;
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        function showView(view) {
            const bettingView = document.getElementById('betting-view');
            const mybetsView = document.getElementById('mybets-view');
            const btns = document.querySelectorAll('.view-toggle button');
            if (view === 'betting') {
                bettingView.style.display = 'block';
                mybetsView.style.display = 'none';
                btns[0].classList.add('active');
                btns[1].classList.remove('active');
            } else {
                bettingView.style.display = 'none';
                mybetsView.style.display = 'block';
                btns[0].classList.remove('active');
                btns[1].classList.add('active');
                loadMyBets();
            }
        }

        async function loadMyBets() {
            try {
                const response = await fetch(`${API_URL}/api/sports/bets/my`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('Failed to load bets');
                const data = await response.json();
                displayStats(data.bets);
                displayBetsHistory(data.bets);
            } catch (e) {
                document.getElementById('stats-container').innerHTML = '<div class="error-box">Error loading stats</div>';
                document.getElementById('bets-history').innerHTML = '<div class="error-box">Error loading bet history</div>';
            }
        }

        function displayStats(bets) {
            const totalBets = bets.length;
            const wonBets = bets.filter(b => b.status === 'won').length;
            const lostBets = bets.filter(b => b.status === 'lost').length;
            const pendingBets = bets.filter(b => b.status === 'pending').length;
            const totalWagered = bets.reduce((s, b) => s + b.stake, 0);
            const totalWon = bets.filter(b => b.status === 'won').reduce((s, b) => s + b.actual_payout, 0);
            const netProfit = totalWon - totalWagered;
            const winRate = wonBets + lostBets > 0 ? ((wonBets / (wonBets + lostBets)) * 100).toFixed(1) : 0;
            const profitClass = netProfit > 0 ? 'profit-pos' : netProfit < 0 ? 'profit-neg' : '';
            document.getElementById('stats-container').innerHTML = `
                <div class="stat-card">
                    <div class="s-label">Total Bets</div>
                    <div class="s-value">${totalBets}</div>
                    <div class="s-sub">${pendingBets} pending</div>
                </div>
                <div class="stat-card">
                    <div class="s-label">Win Rate</div>
                    <div class="s-value">${winRate}%</div>
                    <div class="s-sub">${wonBets}W - ${lostBets}L</div>
                </div>
                <div class="stat-card ${profitClass}">
                    <div class="s-label">Net Profit</div>
                    <div class="s-value">${netProfit > 0 ? '+' : ''}${netProfit.toFixed(0)}</div>
                    <div class="s-sub">Wagered: ${totalWagered} pts</div>
                </div>
                <div class="stat-card">
                    <div class="s-label">Total Won</div>
                    <div class="s-value">${totalWon.toFixed(0)}</div>
                    <div class="s-sub">From ${wonBets} winning bets</div>
                </div>`;
        }

        function displayBetsHistory(bets) {
            const container = document.getElementById('bets-history');
            if (bets.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:28px;">No bets placed yet</div>';
                return;
            }
            container.innerHTML = bets.map(bet => {
                const statusClass = bet.status.toLowerCase();
                const betType = bet.is_parlay ? `${bet.total_picks}-Leg Parlay` : 'Single Bet';
                const picksHtml = bet.picks.map(pick => {
                    const resultIcon = pick.result
                        ? (pick.result === 'won' ? '‚úì' : pick.result === 'lost' ? '‚úó' : pick.result === 'push' ? '‚Üî' : '‚ãØ')
                        : '‚ãØ';
                    const resultClass = pick.result || 'pending';
                    let selText = pick.bet_type === 'moneyline' ? `${pick.selection.toUpperCase()} ML`
                        : pick.bet_type === 'spread' ? `${pick.selection.toUpperCase()} ${pick.point > 0 ? '+' : ''}${pick.point}`
                        : `${pick.selection.toUpperCase()} ${pick.point}`;
                    return `<div class="pick-item">
                        <span class="pick-result ${resultClass}">${resultIcon}</span>
                        <div style="flex:1;">
                            <strong>${pick.match_description}</strong><br>
                            <span>${selText} (${pick.odds > 0 ? '+' : ''}${pick.odds})</span>
                        </div>
                    </div>`;
                }).join('');
                const placedDate = new Date(bet.placed_at).toLocaleString('en-US', {
                    month: 'short', day: 'numeric', year: 'numeric',
                    hour: 'numeric', minute: '2-digit',
                    timeZone: 'America/New_York', timeZoneName: 'short'
                });
                const payout = bet.status === 'won' ? bet.actual_payout : bet.status === 'push' ? bet.stake : 0;
                return `<div class="bet-card ${statusClass}">
                    <div class="bet-header">
                        <span class="bet-type-badge">${betType}</span>
                        <span class="bet-status ${statusClass}">${bet.status}</span>
                    </div>
                    <div class="bet-picks">${picksHtml}</div>
                    <div class="bet-amount">
                        <span class="stake">Stake: ${bet.stake} pts</span>
                        <span class="payout ${bet.status === 'won' ? 'won' : ''}">
                            ${bet.status === 'pending' ? `To Win: ${bet.potential_payout.toFixed(2)} pts`
                              : bet.status === 'won' ? `Won: +${payout.toFixed(2)} pts`
                              : bet.status === 'push' ? `Returned: ${payout.toFixed(2)} pts`
                              : `Lost: -${bet.stake} pts`}
                        </span>
                    </div>
                    <div class="bet-date">${placedDate}</div>
                </div>`;
            }).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!requireRole('user', 'admin')) return;
            document.querySelector('.filter-tab').classList.add('active');
            loadSyncStatus();
            loadGames(null);
            setInterval(loadSyncStatus, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
