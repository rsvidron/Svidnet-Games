<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Svidhaus Arena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root[data-theme="dark"] {
            --bg: #0f0f0f; --sidebar-bg: #1a1a1a; --card-bg: #1e1e1e;
            --card-border: #2a2a2a; --text-primary: #ffffff; --text-secondary: #888888;
            --text-muted: #555555; --accent: #22c55e; --accent-hover: #16a34a;
            --accent-dim: rgba(34,197,94,0.1); --danger: #ef4444;
            --input-bg: #2a2a2a; --input-border: #333333;
            --hover-bg: #252525; --divider: #2a2a2a; --modal-bg: #1a1a1a;
            --table-header: #252525; --badge-active-bg: rgba(34,197,94,0.15);
            --badge-active-text: #22c55e;
        }
        :root[data-theme="light"] {
            --bg: #f4f6f9; --sidebar-bg: #ffffff; --card-bg: #ffffff;
            --card-border: #e5e7eb; --text-primary: #111827; --text-secondary: #6b7280;
            --text-muted: #9ca3af; --accent: #16a34a; --accent-hover: #15803d;
            --accent-dim: rgba(22,163,74,0.08); --danger: #dc2626;
            --input-bg: #f9fafb; --input-border: #d1d5db;
            --hover-bg: #f3f4f6; --divider: #e5e7eb; --modal-bg: #ffffff;
            --table-header: #f9fafb; --badge-active-bg: #d1fae5;
            --badge-active-text: #065f46;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text-primary);
            min-height: 100vh; display: flex; transition: background 0.3s, color 0.3s;
        }

        /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
        .sidebar {
            width: 240px; background: var(--sidebar-bg); border-right: 1px solid var(--divider);
            display: flex; flex-direction: column; padding: 24px 0;
            position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
            transition: background 0.3s, border-color 0.3s, transform 0.3s;
        }
        .sidebar-logo { padding: 0 24px 28px; border-bottom: 1px solid var(--divider); margin-bottom: 16px; }
        .sidebar-logo h1 { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .sidebar-logo span { font-size: 12px; color: var(--text-secondary); }
        .sidebar-section { padding: 0 12px; margin-bottom: 8px; }
        .sidebar-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; padding: 0 12px; margin-bottom: 4px; }
        .sidebar-item {
            display: flex; align-items: center; gap: 10px; padding: 10px 12px;
            border-radius: 8px; font-size: 14px; font-weight: 500; color: var(--text-secondary);
            cursor: pointer; text-decoration: none; transition: background 0.15s, color 0.15s; margin-bottom: 2px;
        }
        .sidebar-item:hover { background: var(--hover-bg); color: var(--text-primary); }
        .sidebar-item.active { background: var(--accent-dim); color: var(--accent); }
        .sidebar-item .icon { font-size: 16px; width: 20px; text-align: center; }
        .soon-badge { margin-left: auto; background: var(--card-border); color: var(--text-muted); font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 10px; }
        .sidebar-bottom { margin-top: auto; padding: 16px 12px; border-top: 1px solid var(--divider); }

        /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
        .main { margin-left: 240px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
        .topbar {
            background: var(--sidebar-bg); border-bottom: 1px solid var(--divider);
            padding: 0 32px; height: 64px; display: flex; align-items: center;
            justify-content: space-between; position: sticky; top: 0; z-index: 50;
            transition: background 0.3s, border-color 0.3s;
        }
        .topbar-left h2 { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .topbar-right { display: flex; align-items: center; gap: 12px; }
        .theme-toggle {
            width: 36px; height: 36px; border-radius: 8px; background: var(--hover-bg);
            border: 1px solid var(--card-border); font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .theme-toggle:hover { background: var(--accent-dim); border-color: var(--accent); }
        .mobile-menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 22px; cursor: pointer; }

        /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
        .content { padding: 28px 32px; flex: 1; }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;
        }
        .tab {
            padding: 9px 20px; background: var(--hover-bg); border: 1px solid var(--card-border);
            border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;
            color: var(--text-secondary); transition: all 0.2s;
        }
        .tab:hover { border-color: var(--accent); color: var(--text-primary); }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* ‚îÄ‚îÄ Content sections ‚îÄ‚îÄ */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
        .card {
            background: var(--card-bg); border: 1px solid var(--card-border);
            border-radius: 12px; padding: 24px; margin-bottom: 20px;
            transition: background 0.3s, border-color 0.3s;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .card-header h2 { font-size: 18px; font-weight: 600; color: var(--text-primary); }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn { padding: 9px 18px; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--hover-bg); color: var(--text-secondary); border: 1px solid var(--card-border); }
        .btn-secondary:hover { background: var(--card-border); color: var(--text-primary); }
        .btn-danger { background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }

        /* ‚îÄ‚îÄ Forms ‚îÄ‚îÄ */
        .form-grid { display: grid; gap: 14px; margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-weight: 500; font-size: 13px; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 10px 12px; background: var(--input-bg);
            border: 1px solid var(--input-border); border-radius: 8px;
            font-size: 14px; color: var(--text-primary); outline: none; transition: border-color 0.2s;
            font-family: inherit;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group select option { background: var(--card-bg); color: var(--text-primary); }

        /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
        .table { width: 100%; border-collapse: collapse; }
        .table th {
            background: var(--table-header); padding: 11px 12px; text-align: left;
            font-weight: 600; color: var(--text-secondary); font-size: 12px;
            text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--divider);
        }
        .table td { padding: 12px; border-bottom: 1px solid var(--divider); color: var(--text-primary); font-size: 14px; }
        .table tr:hover td { background: var(--hover-bg); }
        .table tr:last-child td { border-bottom: none; }

        /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
        .badge { display: inline-block; padding: 3px 9px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .badge.active { background: var(--badge-active-bg); color: var(--badge-active-text); }
        .badge.inactive { background: rgba(239,68,68,0.1); color: var(--danger); }
        .badge.easy { background: rgba(59,130,246,0.1); color: #3b82f6; }
        .badge.medium { background: rgba(245,158,11,0.1); color: #f59e0b; }
        .badge.hard { background: rgba(239,68,68,0.1); color: var(--danger); }

        /* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
        .actions { display: flex; gap: 6px; }

        /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
        .empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 40px; margin-bottom: 12px; }

        /* ‚îÄ‚îÄ Import section ‚îÄ‚îÄ */
        .import-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .import-box {
            border: 1px solid var(--card-border); border-radius: 10px; padding: 20px;
            background: var(--hover-bg);
        }
        .import-box h3 { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 14px; }
        .import-result {
            margin-top: 16px; padding: 12px 16px; border-radius: 8px;
            font-size: 13px; display: none;
        }
        .import-result.success { background: var(--badge-active-bg); color: var(--badge-active-text); display: block; }
        .import-result.error { background: rgba(239,68,68,0.1); color: var(--danger); display: block; }

        /* ‚îÄ‚îÄ Wordle word grid ‚îÄ‚îÄ */
        .word-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 10px;
        }
        .word-card {
            border: 1px solid var(--card-border); border-radius: 8px; padding: 12px;
            text-align: center; background: var(--hover-bg);
        }
        .word-card.active-word { border-color: var(--accent); }
        .word-card .word-text { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .word-card .word-meta { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; }
        .word-card .word-actions { display: flex; gap: 5px; justify-content: center; }

        /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.6); z-index: 1000;
            align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal.show { display: flex; }
        .modal-content {
            background: var(--modal-bg); border: 1px solid var(--card-border);
            border-radius: 16px; padding: 28px; max-width: 560px; width: 90%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--text-muted); line-height: 1; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }

        /* ‚îÄ‚îÄ Alert ‚îÄ‚îÄ */
        .alert { padding: 11px 14px; border-radius: 8px; margin-bottom: 14px; font-size: 13px; }
        .alert-success { background: var(--badge-active-bg); color: var(--badge-active-text); }
        .alert-error { background: rgba(239,68,68,0.1); color: var(--danger); }

        /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
            .topbar { padding: 0 16px; }
            .content { padding: 16px; }
            .mobile-menu-btn { display: block; }
            .tabs { gap: 6px; }
            .tab { padding: 8px 14px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h1>Svidhaus Arena</h1>
            <span>Gaming Hub</span>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-label">Menu</div>
            <a href="/" class="sidebar-item"><span class="icon">‚äû</span> Dashboard</a>
            <a href="/profile" class="sidebar-item"><span class="icon">üë§</span> Profile</a>
            <a href="/links" class="sidebar-item"><span class="icon">üîó</span> Links</a>
            <a href="/admin" class="sidebar-item active"><span class="icon">‚öôÔ∏è</span> Admin</a>
        </div>
        <div class="sidebar-section" style="margin-top:12px;">
            <div class="sidebar-label">Games</div>
            <a href="/trivia" class="sidebar-item"><span class="icon">ü§ì</span> Trivia</a>
            <a href="/wordle" class="sidebar-item"><span class="icon">üü©</span> Wordle</a>
            <a href="/sportsbook" class="sidebar-item"><span class="icon">üèà</span> Sportsbook</a>
            <a href="/movies" class="sidebar-item"><span class="icon">üé¨</span> Movies &amp; TV</a>
            <a href="/wrestling" class="sidebar-item"><span class="icon">ü§º</span> Wrestling</a>
        </div>
        <div class="sidebar-bottom">
            <button class="sidebar-item" onclick="logout()" style="background:none;border:none;text-align:left;width:100%;color:var(--danger);cursor:pointer;">
                <span class="icon">‚Ü©</span> Logout
            </button>
        </div>
    </aside>

    <div class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <div class="topbar-left"><h2>Admin Panel</h2></div>
            </div>
            <div class="topbar-right">
                <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">‚òÄÔ∏è</button>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('categories', this)">Categories</button>
                <button class="tab" onclick="switchTab('questions', this)">Questions</button>
                <button class="tab" onclick="switchTab('wordle', this)">Wordle Words</button>
                <button class="tab" onclick="switchTab('links', this)">Links</button>
                <button class="tab" onclick="switchTab('collections', this)">Collections</button>
                <button class="tab" onclick="switchTab('users', this)">Users</button>
                <button class="tab" onclick="switchTab('wrestling', this)">ü§º Wrestling</button>
                <button class="tab" onclick="switchTab('import', this)">Import/Export</button>
            </div>

            <!-- Categories Section -->
            <div class="content-section active" id="categories-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Trivia Categories</h2>
                        <button class="btn btn-primary" onclick="showCreateCategoryModal()">+ New Category</button>
                    </div>
                    <div id="categories-list"></div>
                </div>
            </div>

            <!-- Questions Section -->
            <div class="content-section" id="questions-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Trivia Questions</h2>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <select id="filter-category" onchange="loadQuestions()" style="padding:8px 12px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:8px;font-size:13px;color:var(--text-primary);outline:none;">
                                <option value="">All Categories</option>
                            </select>
                            <button class="btn btn-primary" onclick="showCreateQuestionModal()">+ New Question</button>
                        </div>
                    </div>
                    <div id="questions-list"></div>
                </div>
            </div>

            <!-- Wordle Words Section -->
            <div class="content-section" id="wordle-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Wordle Words</h2>
                        <button class="btn btn-primary" onclick="showCreateWordModal()">+ New Word</button>
                    </div>
                    <div id="wordle-words-list"></div>
                </div>
            </div>

            <!-- Links Section -->
            <div class="content-section" id="links-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Links Dashboard</h2>
                        <button class="btn btn-primary" onclick="showCreateLinkModal()">+ New Link</button>
                    </div>
                    <div id="links-list"></div>
                </div>
            </div>

            <!-- Collections Section -->
            <div class="content-section" id="collections-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Movie & TV Collections</h2>
                        <button class="btn btn-primary" onclick="showCreateCollectionModal()">+ New Collection</button>
                    </div>
                    <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">
                        Create curated collections that users can browse and rank (e.g. Marvel Cinematic Universe, Nolan Films).
                    </p>
                    <div id="collections-list"></div>
                </div>
            </div>

            <!-- Users Section -->
            <div class="content-section" id="users-section">
                <div class="card">
                    <div class="card-header">
                        <h2>User Management</h2>
                        <div style="font-size:13px;color:var(--text-muted);" id="users-count"></div>
                    </div>
                    <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">
                        Manage user roles and accounts. Roles: <strong>Basic</strong> (Wordle/Trivia only) ‚Üí <strong>User</strong> (full access) ‚Üí <strong>Admin</strong> (everything).
                    </p>
                    <div style="margin-bottom:16px;">
                        <input type="text" id="user-search" placeholder="Search by username or email..." oninput="filterUsers()"
                            style="width:100%;max-width:360px;padding:9px 14px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:8px;font-size:13px;color:var(--text-primary);outline:none;font-family:inherit;">
                    </div>
                    <div id="users-list"></div>
                </div>
            </div>

            <!-- Wrestling Section -->
            <div class="content-section" id="wrestling-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Wrestling Prediction Events</h2>
                        <button class="btn btn-primary" onclick="showCreateEventModal()">+ New Event</button>
                    </div>
                    <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">
                        Create prediction forms for wrestling shows. Add questions, lock submissions, then submit correct answers to auto-grade everyone.
                    </p>
                    <div id="wrestling-events-list"></div>
                </div>
            </div>

            <!-- Import/Export Section -->
            <div class="content-section" id="import-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Bulk Import/Export</h2>
                    </div>
                    <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">Download CSV templates, edit them, and import in bulk.</p>
                    <div class="import-grid">
                        <div class="import-box">
                            <h3>üìÅ Categories</h3>
                            <button class="btn btn-secondary" onclick="downloadTemplate('categories')" style="width:100%;margin-bottom:8px;">‚¨á Download Template</button>
                            <input type="file" id="categories-file" accept=".csv" style="display:none;" onchange="handleFileUpload('categories', this.files[0])">
                            <button class="btn btn-primary" onclick="document.getElementById('categories-file').click()" style="width:100%;">‚¨Ü Import CSV</button>
                        </div>
                        <div class="import-box">
                            <h3>‚ùì Questions</h3>
                            <button class="btn btn-secondary" onclick="downloadTemplate('questions')" style="width:100%;margin-bottom:8px;">‚¨á Download Template</button>
                            <input type="file" id="questions-file" accept=".csv" style="display:none;" onchange="handleFileUpload('questions', this.files[0])">
                            <button class="btn btn-primary" onclick="document.getElementById('questions-file').click()" style="width:100%;">‚¨Ü Import CSV</button>
                        </div>
                        <div class="import-box">
                            <h3>üü© Wordle Words</h3>
                            <button class="btn btn-secondary" onclick="downloadTemplate('wordle-words')" style="width:100%;margin-bottom:8px;">‚¨á Download Template</button>
                            <input type="file" id="wordle-words-file" accept=".csv" style="display:none;" onchange="handleFileUpload('wordle-words', this.files[0])">
                            <button class="btn btn-primary" onclick="document.getElementById('wordle-words-file').click()" style="width:100%;">‚¨Ü Import CSV</button>
                        </div>
                    </div>
                    <div id="import-results" style="margin-top:16px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="category-modal-title">New Category</h3>
                <button class="modal-close" onclick="closeModal('category-modal')">√ó</button>
            </div>
            <div id="category-alert"></div>
            <form id="category-form" onsubmit="saveCategory(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="category-name" required>
                    </div>
                    <div class="form-group">
                        <label>Icon (emoji)</label>
                        <input type="text" id="category-icon" placeholder="e.g., üß¨" maxlength="2">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="category-description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('category-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Question Modal -->
    <div class="modal" id="question-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="question-modal-title">New Question</h3>
                <button class="modal-close" onclick="closeModal('question-modal')">√ó</button>
            </div>
            <div id="question-alert"></div>
            <form id="question-form" onsubmit="saveQuestion(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="question-category" required></select>
                    </div>
                    <div class="form-group">
                        <label>Difficulty *</label>
                        <select id="question-difficulty" required>
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Question *</label>
                        <textarea id="question-text" required rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Option A *</label>
                        <input type="text" id="question-option-a" required>
                    </div>
                    <div class="form-group">
                        <label>Option B *</label>
                        <input type="text" id="question-option-b" required>
                    </div>
                    <div class="form-group">
                        <label>Option C *</label>
                        <input type="text" id="question-option-c" required>
                    </div>
                    <div class="form-group">
                        <label>Option D *</label>
                        <input type="text" id="question-option-d" required>
                    </div>
                    <div class="form-group">
                        <label>Correct Answer *</label>
                        <select id="question-correct" required>
                            <option value="0">A</option>
                            <option value="1">B</option>
                            <option value="2">C</option>
                            <option value="3">D</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Explanation</label>
                        <textarea id="question-explanation" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('question-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Question</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Wordle Word Modal -->
    <div class="modal" id="word-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="word-modal-title">New Word</h3>
                <button class="modal-close" onclick="closeModal('word-modal')">√ó</button>
            </div>
            <div id="word-alert"></div>
            <form id="word-form" onsubmit="saveWord(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Word (5 letters)</label>
                        <input type="text" id="word-text" maxlength="5" pattern="[A-Za-z]{5}" required style="text-transform:uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="word-difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('word-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Word</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Link Modal -->
    <div class="modal" id="link-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="link-modal-title">New Link</h3>
                <button class="modal-close" onclick="closeModal('link-modal')">√ó</button>
            </div>
            <div id="link-alert"></div>
            <form id="link-form" onsubmit="saveLink(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="link-title" required>
                    </div>
                    <div class="form-group">
                        <label>URL *</label>
                        <input type="url" id="link-url" required placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="link-description" placeholder="Short description">
                    </div>
                    <div class="form-group">
                        <label>Icon (emoji)</label>
                        <input type="text" id="link-icon" placeholder="e.g. üè†" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="link-category" placeholder="e.g. Home Lab, Tools, Media">
                    </div>
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="link-sort-order" value="0" min="0">
                    </div>
                    <div class="form-group" style="display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="link-new-tab" checked style="width:auto;">
                        <label for="link-new-tab" style="margin-bottom:0;">Open in new tab</label>
                    </div>
                    <div class="form-group" style="display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="link-active" checked style="width:auto;">
                        <label for="link-active" style="margin-bottom:0;">Active (visible on Links page)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('link-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Link</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Collection Modal -->
    <div class="modal" id="collection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="collection-modal-title">New Collection</h3>
                <button class="modal-close" onclick="closeModal('collection-modal')">√ó</button>
            </div>
            <div id="collection-alert"></div>
            <form id="collection-form" onsubmit="saveCollection(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" id="collection-title" required placeholder="e.g. Marvel Cinematic Universe">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="collection-description" placeholder="What's this collection about?" rows="3"></textarea>
                    </div>
                    <div class="form-group" style="display:flex;align-items:center;gap:10px;">
                        <input type="checkbox" id="collection-active" checked style="width:auto;">
                        <label for="collection-active" style="margin-bottom:0;">Active (visible to users)</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('collection-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Collection</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Item to Collection Modal -->
    <div class="modal" id="add-item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Items to <span id="add-item-collection-name"></span></h3>
                <button class="modal-close" onclick="closeModal('add-item-modal')">√ó</button>
            </div>
            <div style="padding:20px;">
                <div class="form-group">
                    <label>Search TMDB</label>
                    <input type="text" id="tmdb-search-input" placeholder="Search for movies or TV shows..." oninput="onTMDBSearch()">
                </div>
                <div id="tmdb-search-results" style="margin-top:12px;max-height:400px;overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        const TMDB_POSTER = 'https://image.tmdb.org/t/p/w92';
        let currentEditingCategory = null;
        let currentEditingQuestion = null;
        let currentEditingWord = null;
        let currentEditingLink = null;
        let currentEditingCollection = null;
        let currentCollectionId = null;
        let tmdbSearchTimeout = null;

        // Theme
        function getTheme() { return localStorage.getItem('theme') || 'dark'; }
        function applyTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('theme-btn').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        function toggleTheme() {
            const n = getTheme() === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', n);
            applyTheme(n);
        }
        applyTheme(getTheme());

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
        async function authFetch(url, options = {}) {
            const res = await fetch(url, options);
            if (res.status === 401) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login?session=expired';
                return res;
            }
            return res;
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', () => {
            const u = getUser();
            if (!u) { window.location.href = '/login'; return; }
            if (u.role !== 'admin') {
                document.body.innerHTML = `<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#0f0f0f;flex-direction:column;gap:16px;font-family:sans-serif;">
                    <div style="font-size:48px;">üîí</div>
                    <div style="font-size:20px;font-weight:700;color:#fff;">Admin Access Required</div>
                    <div style="font-size:14px;color:#888;text-align:center;max-width:320px;">You don't have permission to access the admin panel.</div>
                    <a href="/" style="margin-top:8px;padding:10px 20px;background:#22c55e;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;">Back to Dashboard</a>
                </div>`;
                return;
            }
            loadCategories();
            loadQuestions();
        });

        function switchTab(tab, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            el.classList.add('active');

            if (tab === 'categories') {
                document.getElementById('categories-section').classList.add('active');
            } else if (tab === 'questions') {
                document.getElementById('questions-section').classList.add('active');
            } else if (tab === 'wordle') {
                document.getElementById('wordle-section').classList.add('active');
                loadWordleWords();
            } else if (tab === 'links') {
                document.getElementById('links-section').classList.add('active');
                loadLinks();
            } else if (tab === 'collections') {
                document.getElementById('collections-section').classList.add('active');
                loadCollections();
            } else if (tab === 'users') {
                document.getElementById('users-section').classList.add('active');
                loadUsers();
            } else if (tab === 'wrestling') {
                document.getElementById('wrestling-section').classList.add('active');
                loadWrestlingEvents();
            } else if (tab === 'import') {
                document.getElementById('import-section').classList.add('active');
            }
        }

        async function loadCategories() {
            try {
                const res = await fetch(`${API_URL}/api/admin/categories`, { headers: authHeaders() });
                const categories = await res.json();
                const list = document.getElementById('categories-list');
                const filterSelect = document.getElementById('filter-category');
                const questionCategorySelect = document.getElementById('question-category');

                if (!Array.isArray(categories)) {
                    list.innerHTML = `<div class="alert alert-error">Failed to load categories: ${categories.detail || 'Unexpected response'}</div>`;
                    return;
                }

                if (categories.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><p>No categories yet. Create your first category!</p></div>';
                    filterSelect.innerHTML = '<option value="">All Categories</option>';
                    questionCategorySelect.innerHTML = '<option value="">Select a category</option>';
                    return;
                }

                list.innerHTML = `<table class="table">
                    <thead><tr>
                        <th>Icon</th><th>Name</th><th>Description</th><th>Questions</th><th>Status</th><th>Actions</th>
                    </tr></thead>
                    <tbody>
                        ${categories.map(cat => `<tr>
                            <td>${cat.icon || 'üìÑ'}</td>
                            <td><strong>${cat.name}</strong></td>
                            <td style="color:var(--text-secondary);">${cat.description || '-'}</td>
                            <td>${cat.question_count}</td>
                            <td><span class="badge ${cat.is_active ? 'active' : 'inactive'}">${cat.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td class="actions">
                                <button class="btn btn-sm btn-secondary" onclick='editCategory(${JSON.stringify(cat)})'>Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCategory(${cat.id})">Delete</button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>`;

                filterSelect.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name}</option>`).join('');
                questionCategorySelect.innerHTML = categories.map(c => `<option value="${c.id}">${c.icon || ''} ${c.name}</option>`).join('');
            } catch (e) {
                alert('Error loading categories: ' + e.message);
            }
        }

        async function loadQuestions() {
            try {
                const categoryId = document.getElementById('filter-category').value;
                const url = categoryId ? `${API_URL}/api/admin/questions?category_id=${categoryId}` : `${API_URL}/api/admin/questions`;
                const res = await fetch(url, { headers: authHeaders() });
                const questions = await res.json();
                const list = document.getElementById('questions-list');

                if (!Array.isArray(questions)) {
                    list.innerHTML = `<div class="alert alert-error">Failed to load questions: ${questions.detail || 'Unexpected response'}</div>`;
                    return;
                }

                if (questions.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùì</div><p>No questions yet. Create your first question!</p></div>';
                    return;
                }

                list.innerHTML = `<table class="table">
                    <thead><tr>
                        <th>Question</th><th>Difficulty</th><th>Stats</th><th>Status</th><th>Actions</th>
                    </tr></thead>
                    <tbody>
                        ${questions.map(q => {
                            const accuracy = q.times_used > 0 ? Math.round((q.times_correct / q.times_used) * 100) : 0;
                            return `<tr>
                                <td><strong>${q.question.substring(0, 80)}${q.question.length > 80 ? '...' : ''}</strong></td>
                                <td><span class="badge ${q.difficulty}">${q.difficulty}</span></td>
                                <td style="color:var(--text-secondary);">Used: ${q.times_used} | ${accuracy}% correct</td>
                                <td><span class="badge ${q.is_active ? 'active' : 'inactive'}">${q.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-secondary" onclick='editQuestion(${JSON.stringify(q).replace(/'/g, "&apos;")})'>Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})">Delete</button>
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
            } catch (e) {
                alert('Error loading questions: ' + e.message);
            }
        }

        function showCreateCategoryModal() {
            currentEditingCategory = null;
            document.getElementById('category-modal-title').textContent = 'New Category';
            document.getElementById('category-form').reset();
            document.getElementById('category-alert').innerHTML = '';
            document.getElementById('category-modal').classList.add('show');
        }

        function editCategory(category) {
            currentEditingCategory = category;
            document.getElementById('category-modal-title').textContent = 'Edit Category';
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-icon').value = category.icon || '';
            document.getElementById('category-description').value = category.description || '';
            document.getElementById('category-alert').innerHTML = '';
            document.getElementById('category-modal').classList.add('show');
        }

        async function saveCategory(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('category-name').value,
                icon: document.getElementById('category-icon').value || null,
                description: document.getElementById('category-description').value || null
            };
            try {
                const url = currentEditingCategory
                    ? `${API_URL}/api/admin/categories/${currentEditingCategory.id}`
                    : `${API_URL}/api/admin/categories`;
                const method = currentEditingCategory ? 'PATCH' : 'POST';
                const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(data) });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed to save'); }
                closeModal('category-modal');
                loadCategories();
                loadQuestions();
            } catch (e) {
                document.getElementById('category-alert').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Delete this category? This will fail if it has questions.')) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/categories/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed'); }
                loadCategories();
            } catch (e) { alert(e.message); }
        }

        function showCreateQuestionModal() {
            currentEditingQuestion = null;
            document.getElementById('question-modal-title').textContent = 'New Question';
            document.getElementById('question-form').reset();
            document.getElementById('question-alert').innerHTML = '';
            document.getElementById('question-modal').classList.add('show');
        }

        function editQuestion(question) {
            currentEditingQuestion = question;
            document.getElementById('question-modal-title').textContent = 'Edit Question';
            document.getElementById('question-category').value = question.category_id;
            document.getElementById('question-difficulty').value = question.difficulty;
            document.getElementById('question-text').value = question.question;
            document.getElementById('question-option-a').value = question.option_a;
            document.getElementById('question-option-b').value = question.option_b;
            document.getElementById('question-option-c').value = question.option_c;
            document.getElementById('question-option-d').value = question.option_d;
            document.getElementById('question-correct').value = question.correct_answer;
            document.getElementById('question-explanation').value = question.explanation || '';
            document.getElementById('question-alert').innerHTML = '';
            document.getElementById('question-modal').classList.add('show');
        }

        async function saveQuestion(e) {
            e.preventDefault();
            const data = {
                category_id: parseInt(document.getElementById('question-category').value),
                difficulty: document.getElementById('question-difficulty').value,
                question: document.getElementById('question-text').value,
                option_a: document.getElementById('question-option-a').value,
                option_b: document.getElementById('question-option-b').value,
                option_c: document.getElementById('question-option-c').value,
                option_d: document.getElementById('question-option-d').value,
                correct_answer: parseInt(document.getElementById('question-correct').value),
                explanation: document.getElementById('question-explanation').value || null
            };
            try {
                const url = currentEditingQuestion
                    ? `${API_URL}/api/admin/questions/${currentEditingQuestion.id}`
                    : `${API_URL}/api/admin/questions`;
                const method = currentEditingQuestion ? 'PATCH' : 'POST';
                const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(data) });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed'); }
                closeModal('question-modal');
                loadQuestions();
                loadCategories();
            } catch (e) {
                document.getElementById('question-alert').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        async function deleteQuestion(id) {
            if (!confirm('Delete this question?')) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/questions/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (!res.ok) throw new Error('Failed to delete');
                loadQuestions();
                loadCategories();
            } catch (e) { alert(e.message); }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ‚îÄ‚îÄ Wordle Words ‚îÄ‚îÄ

        async function loadWordleWords() {
            try {
                const res = await fetch(`${API_URL}/api/admin/wordle-words`, { headers: authHeaders() });
                const words = await res.json();
                const list = document.getElementById('wordle-words-list');

                if (words.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üü©</div><p>No words yet. Add one!</p></div>';
                    return;
                }

                list.innerHTML = `<div class="word-grid">
                    ${words.map(word => `
                        <div class="word-card ${word.is_active ? 'active-word' : ''}">
                            <div class="word-text">${word.word}</div>
                            <div class="word-meta">${word.difficulty} ¬∑ ${word.times_used} uses</div>
                            <div class="word-actions">
                                <button class="btn btn-sm btn-secondary" onclick="editWord(${word.id})">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWord(${word.id}, '${word.word}')">Del</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            } catch (e) {
                console.error('Failed to load words:', e);
            }
        }

        function showCreateWordModal() {
            currentEditingWord = null;
            document.getElementById('word-modal-title').textContent = 'New Word';
            document.getElementById('word-text').value = '';
            document.getElementById('word-text').disabled = false;
            document.getElementById('word-difficulty').value = 'medium';
            document.getElementById('word-alert').innerHTML = '';
            document.getElementById('word-modal').classList.add('show');
        }

        async function editWord(wordId) {
            const res = await fetch(`${API_URL}/api/admin/wordle-words`, { headers: authHeaders() });
            const words = await res.json();
            currentEditingWord = words.find(w => w.id === wordId);
            if (!currentEditingWord) return;
            document.getElementById('word-modal-title').textContent = 'Edit Word';
            document.getElementById('word-text').value = currentEditingWord.word;
            document.getElementById('word-text').disabled = true;
            document.getElementById('word-difficulty').value = currentEditingWord.difficulty;
            document.getElementById('word-alert').innerHTML = '';
            document.getElementById('word-modal').classList.add('show');
        }

        async function saveWord(e) {
            e.preventDefault();
            const data = {
                word: document.getElementById('word-text').value.toUpperCase().trim(),
                difficulty: document.getElementById('word-difficulty').value
            };
            const url = currentEditingWord ? `${API_URL}/api/admin/wordle-words/${currentEditingWord.id}` : `${API_URL}/api/admin/wordle-words`;
            const method = currentEditingWord ? 'PATCH' : 'POST';
            try {
                const res = await fetch(url, {
                    method,
                    headers: authHeaders(),
                    body: JSON.stringify(currentEditingWord ? { difficulty: data.difficulty } : data)
                });
                if (res.ok) {
                    closeModal('word-modal');
                    await loadWordleWords();
                } else {
                    const error = await res.json();
                    document.getElementById('word-alert').innerHTML = `<div class="alert alert-error">${error.detail || 'Failed to save word'}</div>`;
                }
            } catch (e) {
                document.getElementById('word-alert').innerHTML = `<div class="alert alert-error">Error: ${e.message}</div>`;
            }
        }

        async function deleteWord(wordId, word) {
            if (!confirm(`Delete word "${word}"?`)) return;
            try {
                await fetch(`${API_URL}/api/admin/wordle-words/${wordId}`, { method: 'DELETE', headers: authHeaders() });
                await loadWordleWords();
            } catch (e) { alert(e.message); }
        }

        // ‚îÄ‚îÄ CSV Import/Export ‚îÄ‚îÄ

        async function downloadTemplate(type) {
            window.open(`${API_URL}/api/admin/export/${type}/template`, '_blank');
        }

        async function handleFileUpload(type, file) {
            if (!file) return;
            const resultsDiv = document.getElementById('import-results');
            resultsDiv.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text-muted);">Uploading...</div>';
            try {
                const formData = new FormData();
                formData.append('file', file);
                const res = await authFetch(`${API_URL}/api/admin/import/${type}`, { method: 'POST', headers: { 'Authorization': `Bearer ${getToken()}` }, body: formData });
                const result = await res.json();
                if (res.ok) {
                    resultsDiv.innerHTML = `<div class="alert alert-success">
                        <strong>‚úì ${result.message}</strong><br>Imported: ${result.imported} rows
                        ${result.errors.length > 0 ? `<br><br><strong>Errors:</strong><ul style="margin-top:8px;">${result.errors.map(e => `<li>${e}</li>`).join('')}</ul>` : ''}
                    </div>`;
                    if (type === 'categories') await loadCategories();
                    if (type === 'questions') await loadQuestions();
                    if (type === 'wordle-words') await loadWordleWords();
                } else {
                    resultsDiv.innerHTML = `<div class="alert alert-error"><strong>Import Failed</strong><br>${result.detail || 'Unknown error'}</div>`;
                }
            } catch (e) {
                resultsDiv.innerHTML = `<div class="alert alert-error"><strong>Error</strong><br>${e.message}</div>`;
            }
            document.getElementById(`${type}-file`).value = '';
        }

        // ‚îÄ‚îÄ Links ‚îÄ‚îÄ

        async function loadLinks() {
            try {
                const res = await fetch(`${API_URL}/api/admin/links/all`, { headers: authHeaders() });
                const links = await res.json();
                const list = document.getElementById('links-list');

                if (!links || links.length === 0) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîó</div><p>No links yet. Add your first link!</p></div>';
                    return;
                }

                list.innerHTML = `<table class="table">
                    <thead><tr>
                        <th>Icon</th><th>Title</th><th>URL</th><th>Category</th><th>Status</th><th>New Tab</th><th>Order</th><th>Actions</th>
                    </tr></thead>
                    <tbody>
                        ${links.map(l => `<tr>
                            <td>${l.icon || 'üîó'}</td>
                            <td><strong>${l.title}</strong>${l.description ? `<br><span style="font-size:11px;color:var(--text-muted);">${l.description}</span>` : ''}</td>
                            <td style="font-size:12px;color:var(--text-secondary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${l.url}</td>
                            <td>${l.category || '‚Äî'}</td>
                            <td><span class="badge ${l.is_active ? 'active' : 'inactive'}">${l.is_active ? 'Active' : 'Hidden'}</span></td>
                            <td>${l.open_in_new_tab ? '‚Üó' : '‚Üí'}</td>
                            <td>${l.sort_order}</td>
                            <td class="actions">
                                <button class="btn btn-sm btn-secondary" onclick='editLink(${JSON.stringify(l)})'>Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLink(${l.id}, '${l.title.replace(/'/g, "\\'")}')">Delete</button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>`;
            } catch (e) {
                document.getElementById('links-list').innerHTML = `<div class="alert alert-error">Error loading links: ${e.message}</div>`;
            }
        }

        function showCreateLinkModal() {
            currentEditingLink = null;
            document.getElementById('link-modal-title').textContent = 'New Link';
            document.getElementById('link-form').reset();
            document.getElementById('link-new-tab').checked = true;
            document.getElementById('link-active').checked = true;
            document.getElementById('link-sort-order').value = 0;
            document.getElementById('link-alert').innerHTML = '';
            document.getElementById('link-modal').classList.add('show');
        }

        function editLink(link) {
            currentEditingLink = link;
            document.getElementById('link-modal-title').textContent = 'Edit Link';
            document.getElementById('link-title').value = link.title;
            document.getElementById('link-url').value = link.url;
            document.getElementById('link-description').value = link.description || '';
            document.getElementById('link-icon').value = link.icon || '';
            document.getElementById('link-category').value = link.category || '';
            document.getElementById('link-sort-order').value = link.sort_order;
            document.getElementById('link-new-tab').checked = link.open_in_new_tab;
            document.getElementById('link-active').checked = link.is_active;
            document.getElementById('link-alert').innerHTML = '';
            document.getElementById('link-modal').classList.add('show');
        }

        async function saveLink(e) {
            e.preventDefault();
            const data = {
                title: document.getElementById('link-title').value,
                url: document.getElementById('link-url').value,
                description: document.getElementById('link-description').value || null,
                icon: document.getElementById('link-icon').value || null,
                category: document.getElementById('link-category').value || null,
                sort_order: parseInt(document.getElementById('link-sort-order').value) || 0,
                open_in_new_tab: document.getElementById('link-new-tab').checked,
                is_active: document.getElementById('link-active').checked,
            };
            try {
                const url = currentEditingLink
                    ? `${API_URL}/api/admin/links/${currentEditingLink.id}`
                    : `${API_URL}/api/admin/links`;
                const method = currentEditingLink ? 'PATCH' : 'POST';
                const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(data) });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed to save'); }
                closeModal('link-modal');
                loadLinks();
            } catch (e) {
                document.getElementById('link-alert').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        async function deleteLink(id, title) {
            if (!confirm(`Delete link "${title}"?`)) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/links/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (!res.ok) throw new Error('Failed to delete');
                loadLinks();
            } catch (e) { alert(e.message); }
        }

        // ‚îÄ‚îÄ Collections Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function loadCollections() {
            try {
                const res = await fetch(`${API_URL}/api/rankings/collections`, { headers: authHeaders() });
                if (!res.ok) throw new Error('Failed to load collections');
                const collections = await res.json();

                const container = document.getElementById('collections-list');
                if (!collections.length) {
                    container.innerHTML = '<div class="alert alert-info">No collections yet. Create the first one!</div>';
                    return;
                }

                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Items</th>
                                    <th>Status</th>
                                    <th style="text-align:right;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${collections.map(c => `
                                    <tr>
                                        <td><strong>${escapeHtml(c.title)}</strong></td>
                                        <td style="color:var(--text-secondary);font-size:13px;">${escapeHtml(c.description || '‚Äî')}</td>
                                        <td><span class="badge">${c.item_count || 0} items</span></td>
                                        <td>${c.is_active ? '<span class="badge badge-active">Active</span>' : '<span class="badge">Inactive</span>'}</td>
                                        <td style="text-align:right;">
                                            <button class="btn-icon" onclick="manageCollectionItems(${c.id}, '${escapeHtml(c.title).replace(/'/g, "\\'")}')">üìã Items</button>
                                            <button class="btn-icon" onclick="editCollection(${JSON.stringify(c).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                                            <button class="btn-icon btn-danger" onclick="deleteCollection(${c.id}, '${escapeHtml(c.title).replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (e) {
                document.getElementById('collections-list').innerHTML = `<div class="alert alert-error">Error loading collections: ${e.message}</div>`;
            }
        }

        function showCreateCollectionModal() {
            currentEditingCollection = null;
            document.getElementById('collection-modal-title').textContent = 'New Collection';
            document.getElementById('collection-form').reset();
            document.getElementById('collection-active').checked = true;
            document.getElementById('collection-alert').innerHTML = '';
            document.getElementById('collection-modal').classList.add('show');
        }

        function editCollection(collection) {
            currentEditingCollection = collection;
            document.getElementById('collection-modal-title').textContent = 'Edit Collection';
            document.getElementById('collection-title').value = collection.title;
            document.getElementById('collection-description').value = collection.description || '';
            document.getElementById('collection-active').checked = collection.is_active;
            document.getElementById('collection-alert').innerHTML = '';
            document.getElementById('collection-modal').classList.add('show');
        }

        async function saveCollection(e) {
            e.preventDefault();
            const data = {
                title: document.getElementById('collection-title').value,
                description: document.getElementById('collection-description').value || null,
                is_active: document.getElementById('collection-active').checked,
            };
            try {
                const url = currentEditingCollection
                    ? `${API_URL}/api/rankings/collections/${currentEditingCollection.id}`
                    : `${API_URL}/api/rankings/collections`;
                const method = currentEditingCollection ? 'PATCH' : 'POST';
                const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(data) });
                if (!res.ok) { const err = await res.json(); throw new Error(err.detail || 'Failed to save'); }
                closeModal('collection-modal');
                loadCollections();
            } catch (e) {
                document.getElementById('collection-alert').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        async function deleteCollection(id, title) {
            if (!confirm(`Delete collection "${title}" and all its items? This cannot be undone.`)) return;
            try {
                const res = await fetch(`${API_URL}/api/rankings/collections/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (!res.ok) throw new Error('Failed to delete');
                loadCollections();
            } catch (e) { alert(e.message); }
        }

        async function manageCollectionItems(collectionId, collectionTitle) {
            currentCollectionId = collectionId;
            document.getElementById('add-item-collection-name').textContent = collectionTitle;

            // Load current items
            try {
                const res = await fetch(`${API_URL}/api/rankings/collections/${collectionId}`, { headers: authHeaders() });
                if (!res.ok) throw new Error('Failed to load collection');
                const collection = await res.json();

                const resultsDiv = document.getElementById('tmdb-search-results');
                const items = collection.items || [];

                if (!items.length) {
                    resultsDiv.innerHTML = '<div class="alert alert-info">No items yet. Search above to add movies and TV shows.</div>';
                } else {
                    resultsDiv.innerHTML = `
                        <div style="margin-bottom:20px;">
                            <h4 style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-primary);">Current Items (${items.length})</h4>
                            <div style="display:flex;flex-direction:column;gap:8px;">
                                ${items.map((item, idx) => `
                                    <div style="display:flex;align-items:center;gap:12px;background:var(--card-bg);border:1px solid var(--card-border);border-radius:8px;padding:10px;">
                                        <span style="min-width:24px;font-weight:700;color:var(--text-muted);">#${idx + 1}</span>
                                        ${item.poster_path ? `<img src="${TMDB_POSTER}${item.poster_path}" style="width:32px;height:48px;border-radius:4px;object-fit:cover;">` : `<div style="width:32px;height:48px;border-radius:4px;background:var(--input-bg);display:flex;align-items:center;justify-content:center;font-size:16px;">${item.media_type === 'tv' ? 'üì∫' : 'üé¨'}</div>`}
                                        <div style="flex:1;">
                                            <div style="font-weight:600;font-size:13px;">${escapeHtml(item.title)}</div>
                                            <div style="font-size:11px;color:var(--text-muted);">${item.media_type.toUpperCase()}${item.release_year ? ' ¬∑ ' + item.release_year : ''}</div>
                                        </div>
                                        <button class="btn btn-danger btn-sm" onclick="removeCollectionItem(${collectionId}, ${item.id}, '${collectionTitle}')">Remove</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="border-top:1px solid var(--divider);padding-top:16px;margin-top:16px;">
                            <h4 style="font-size:14px;font-weight:600;margin-bottom:8px;color:var(--text-primary);">Add More Items</h4>
                            <p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Search for movies or TV shows to add to this collection.</p>
                        </div>
                    `;
                }

                document.getElementById('tmdb-search-input').value = '';
                document.getElementById('add-item-modal').classList.add('show');
            } catch (e) {
                alert('Failed to load collection: ' + e.message);
            }
        }

        function onTMDBSearch() {
            clearTimeout(tmdbSearchTimeout);
            const query = document.getElementById('tmdb-search-input').value.trim();
            if (!query) return;
            tmdbSearchTimeout = setTimeout(() => searchTMDB(query), 400);
        }

        async function searchTMDB(query) {
            const resultsDiv = document.getElementById('tmdb-search-results');
            const existingContent = resultsDiv.innerHTML;

            // Append search results after existing items
            try {
                const res = await fetch(`${API_URL}/api/rankings/search?q=${encodeURIComponent(query)}&media_type=multi`);
                const data = await res.json();
                const results = data.results || [];

                if (!results.length) {
                    // Keep existing items, just show no results message
                    const searchSection = `<div style="border-top:1px solid var(--divider);padding-top:16px;margin-top:16px;">
                        <div class="alert alert-info">No results found for "${query}"</div>
                    </div>`;

                    // Replace only the search section
                    if (existingContent.includes('Current Items')) {
                        resultsDiv.innerHTML = existingContent.split('<div style="border-top:1px solid var(--divider);padding-top:16px;margin-top:16px;">')[0] + searchSection;
                    } else {
                        resultsDiv.innerHTML = searchSection;
                    }
                    return;
                }

                const searchSection = `<div style="border-top:1px solid var(--divider);padding-top:16px;margin-top:16px;">
                    <h4 style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-primary);">Search Results</h4>
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        ${results.slice(0, 10).map(r => `
                            <div style="display:flex;align-items:center;gap:12px;background:var(--hover-bg);border:1px solid var(--card-border);border-radius:8px;padding:10px;cursor:pointer;transition:border-color 0.2s;" onclick="addItemToCollection(${JSON.stringify(r).replace(/"/g, '&quot;')})">
                                ${r.poster_path ? `<img src="${TMDB_POSTER}${r.poster_path}" style="width:32px;height:48px;border-radius:4px;object-fit:cover;">` : `<div style="width:32px;height:48px;border-radius:4px;background:var(--input-bg);display:flex;align-items:center;justify-content:center;font-size:16px;">${r.media_type === 'tv' ? 'üì∫' : 'üé¨'}</div>`}
                                <div style="flex:1;">
                                    <div style="font-weight:600;font-size:13px;">${escapeHtml(r.title)}</div>
                                    <div style="font-size:11px;color:var(--text-muted);">${r.media_type.toUpperCase()}${r.release_year ? ' ¬∑ ' + r.release_year : ''}</div>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();addItemToCollection(${JSON.stringify(r).replace(/"/g, '&quot;')})">+ Add</button>
                            </div>
                        `).join('')}
                    </div>
                </div>`;

                // Replace only the search section
                if (existingContent.includes('Current Items')) {
                    resultsDiv.innerHTML = existingContent.split('<div style="border-top:1px solid var(--divider);padding-top:16px;margin-top:16px;">')[0] + searchSection;
                } else {
                    resultsDiv.innerHTML = searchSection;
                }
            } catch (e) {
                console.error('Search failed:', e);
            }
        }

        async function addItemToCollection(result) {
            if (!currentCollectionId) return;
            const sortOrder = 999; // Will be appended at the end

            try {
                const res = await fetch(`${API_URL}/api/rankings/collections/${currentCollectionId}/items`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        media_id: String(result.id),
                        media_type: result.media_type,
                        title: result.title,
                        poster_path: result.poster_path || null,
                        release_year: result.release_year || null,
                        overview: result.overview || null,
                        sort_order: sortOrder,
                    }),
                });

                if (res.status === 409) {
                    alert('This item is already in the collection.');
                    return;
                }
                if (!res.ok) throw new Error('Failed to add item');

                // Reload the items view
                const collectionName = document.getElementById('add-item-collection-name').textContent;
                await manageCollectionItems(currentCollectionId, collectionName);
            } catch (e) {
                alert('Failed to add item: ' + e.message);
            }
        }

        async function removeCollectionItem(collectionId, itemId, collectionName) {
            if (!confirm('Remove this item from the collection?')) return;

            try {
                const res = await fetch(`${API_URL}/api/rankings/collections/${collectionId}/items/${itemId}`, {
                    method: 'DELETE',
                    headers: authHeaders(),
                });
                if (!res.ok) throw new Error('Failed to remove item');

                // Reload the items view
                await manageCollectionItems(collectionId, collectionName);
            } catch (e) {
                alert('Failed to remove item: ' + e.message);
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function getToken() { return localStorage.getItem('access_token') || localStorage.getItem('token'); }
        function getUser() { try { return JSON.parse(localStorage.getItem('user')); } catch { return null; } }
        function authHeaders() {
            return { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' };
        }

        // ‚îÄ‚îÄ User Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let allUsers = [];

        const ROLE_LABELS = { basic: 'Basic', user: 'User', admin: 'Admin' };
        const ROLE_COLORS = { basic: '#6b7280', user: '#3b82f6', admin: '#22c55e' };

        async function loadUsers() {
            const container = document.getElementById('users-list');
            container.innerHTML = '<div style="padding:20px;color:var(--text-muted);">Loading...</div>';
            try {
                const res = await fetch(`${API_URL}/api/admin/users`, { headers: authHeaders() });
                if (!res.ok) throw new Error(await res.text());
                allUsers = await res.json();
                document.getElementById('users-count').textContent = `${allUsers.length} user${allUsers.length !== 1 ? 's' : ''}`;
                renderUsers(allUsers);
            } catch (e) {
                container.innerHTML = `<div style="padding:20px;color:var(--danger);">Failed to load users: ${e.message}</div>`;
            }
        }

        function filterUsers() {
            const q = document.getElementById('user-search').value.toLowerCase();
            const filtered = q ? allUsers.filter(u => u.username.toLowerCase().includes(q) || u.email.toLowerCase().includes(q)) : allUsers;
            renderUsers(filtered);
        }

        function renderUsers(users) {
            const container = document.getElementById('users-list');
            if (!users.length) {
                container.innerHTML = '<div style="padding:20px;color:var(--text-muted);">No users found.</div>';
                return;
            }
            const me = getUser();
            container.innerHTML = `
                <table class="table">
                    <thead><tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Active</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr></thead>
                    <tbody>
                        ${users.map(u => {
                            const isSelf = me && u.id === me.id;
                            const roleColor = ROLE_COLORS[u.role] || '#6b7280';
                            const joined = u.created_at ? new Date(u.created_at).toLocaleDateString() : '‚Äî';
                            return `<tr>
                                <td><strong>${escapeHtml(u.username)}</strong>${isSelf ? ' <span style="font-size:10px;color:var(--accent);">(you)</span>' : ''}</td>
                                <td style="color:var(--text-secondary);font-size:13px;">${escapeHtml(u.email)}</td>
                                <td>
                                    <select onchange="changeUserRole(${u.id}, this.value)" ${isSelf ? 'disabled' : ''}
                                        style="padding:4px 8px;background:${roleColor}22;color:${roleColor};border:1px solid ${roleColor}44;border-radius:6px;font-size:12px;font-weight:700;cursor:${isSelf ? 'not-allowed' : 'pointer'};outline:none;">
                                        ${['basic','user','admin'].map(r => `<option value="${r}" ${u.role === r ? 'selected' : ''}>${ROLE_LABELS[r]}</option>`).join('')}
                                    </select>
                                </td>
                                <td><span style="color:${u.is_active ? 'var(--accent)' : 'var(--danger)'};">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td style="font-size:12px;color:var(--text-muted);">${joined}</td>
                                <td>
                                    ${isSelf ? '‚Äî' : `<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id}, '${escapeHtml(u.username)}')">Delete</button>`}
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
        }

        async function changeUserRole(userId, newRole) {
            try {
                const res = await fetch(`${API}/api/admin/users/${userId}/role`, {
                    method: 'PATCH',
                    headers: authHeaders(),
                    body: JSON.stringify({ role: newRole }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                // Update local cache without full reload
                const u = allUsers.find(x => x.id === userId);
                if (u) u.role = newRole;
            } catch (e) {
                alert('Failed to update role: ' + e.message);
                loadUsers(); // refresh to reset select
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
            try {
                const res = await fetch(`${API}/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: authHeaders(),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                loadUsers();
            } catch (e) {
                alert('Failed to delete user: ' + e.message);
            }
        }

        // ‚îÄ‚îÄ Wrestling Admin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let wrestlingEvents = [];
        let currentWrestlingEvent = null;   // event being edited
        let currentWrestlingEventId = null; // event whose questions are open
        let wrestlingQuestions = [];        // questions for currently open event
        let editingQuestion = null;

        async function loadWrestlingEvents() {
            const list = document.getElementById('wrestling-events-list');
            list.innerHTML = '<div style="color:var(--text-muted);padding:16px;">Loading‚Ä¶</div>';
            try {
                const res = await fetch(`${API_URL}/api/wrestling/events`, { headers: authHeaders() });
                wrestlingEvents = await res.json();
                if (!wrestlingEvents.length) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ü§º</div><p>No events yet. Create your first wrestling event!</p></div>';
                    return;
                }
                list.innerHTML = wrestlingEvents.map(ev => `
                    <div style="border:1px solid var(--card-border);border-radius:12px;padding:20px;margin-bottom:16px;background:var(--card-bg);">
                        <div style="display:flex;align-items:flex-start;gap:16px;">
                            ${ev.image_url ? `<img src="${ev.image_url}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;flex-shrink:0;">` : `<div style="width:80px;height:80px;background:var(--input-bg);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px;flex-shrink:0;">ü§º</div>`}
                            <div style="flex:1;min-width:0;">
                                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
                                    <strong style="font-size:16px;">${ev.title}</strong>
                                    ${ev.is_locked ? '<span class="badge inactive">üîí Locked</span>' : '<span class="badge active">Open</span>'}
                                    ${ev.is_graded ? '<span class="badge active" style="background:rgba(59,130,246,0.15);color:#3b82f6;">‚úì Graded</span>' : ''}
                                </div>
                                ${ev.event_date ? `<div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">üìÖ ${new Date(ev.event_date).toLocaleDateString()}</div>` : ''}
                                ${ev.description ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px;">${ev.description}</div>` : ''}
                                <div style="font-size:12px;color:var(--text-muted);">${ev.question_count} question${ev.question_count !== 1 ? 's' : ''}</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;padding-top:14px;border-top:1px solid var(--divider);">
                            <button class="btn btn-sm btn-secondary" onclick="openEventQuestions(${ev.id})">‚úèÔ∏è Questions</button>
                            <button class="btn btn-sm btn-secondary" onclick="showEditEventModal(${ev.id})">Edit</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleLockEvent(${ev.id}, ${ev.is_locked})">${ev.is_locked ? 'üîì Unlock' : 'üîí Lock'}</button>
                            <button class="btn btn-sm btn-secondary" onclick="openGradeModal(${ev.id})">üèÜ Grade</button>
                            <button class="btn btn-sm btn-secondary" onclick="openSubmissionsModal(${ev.id})">üë• Submissions</button>
                            <button class="btn btn-sm btn-secondary" onclick="notifyWrestlingEvent(${ev.id}, '${ev.title.replace(/'/g,"\\'")}')">üìß Notify</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWrestlingEvent(${ev.id}, '${ev.title.replace(/'/g,"\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = `<div class="alert alert-error">Failed to load events: ${e.message}</div>`;
            }
        }

        // ‚îÄ‚îÄ Event modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function showCreateEventModal() {
            currentWrestlingEvent = null;
            document.getElementById('w-event-modal-title').textContent = 'New Wrestling Event';
            document.getElementById('w-event-form').reset();
            document.getElementById('w-event-alert').innerHTML = '';
            document.getElementById('w-event-notify-row').style.display = '';
            document.getElementById('w-event-notify').checked = false;
            document.getElementById('w-event-modal').classList.add('show');
        }

        function showEditEventModal(eventId) {
            const ev = wrestlingEvents.find(e => e.id === eventId);
            if (!ev) return;
            currentWrestlingEvent = ev;
            document.getElementById('w-event-modal-title').textContent = 'Edit Event';
            document.getElementById('w-event-title').value = ev.title;
            document.getElementById('w-event-description').value = ev.description || '';
            document.getElementById('w-event-image-url').value = ev.image_url || '';
            document.getElementById('w-event-date').value = ev.event_date ? ev.event_date.substring(0, 16) : '';
            document.getElementById('w-event-alert').innerHTML = '';
            // Hide notify checkbox on edit (only relevant for new events)
            document.getElementById('w-event-notify-row').style.display = 'none';
            document.getElementById('w-event-modal').classList.add('show');
        }

        async function saveWrestlingEvent(e) {
            e.preventDefault();
            const isNew = !currentWrestlingEvent;
            const data = {
                title:       document.getElementById('w-event-title').value.trim(),
                description: document.getElementById('w-event-description').value.trim() || null,
                image_url:   document.getElementById('w-event-image-url').value.trim() || null,
                event_date:  document.getElementById('w-event-date').value || null,
            };
            if (isNew) {
                data.notify_users = document.getElementById('w-event-notify').checked;
            }
            try {
                const url    = currentWrestlingEvent ? `${API_URL}/api/wrestling/events/${currentWrestlingEvent.id}` : `${API_URL}/api/wrestling/events`;
                const method = currentWrestlingEvent ? 'PATCH' : 'POST';
                const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(data) });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                closeModal('w-event-modal');
                loadWrestlingEvents();
            } catch (err) {
                document.getElementById('w-event-alert').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
            }
        }

        async function toggleLockEvent(eventId, currentlyLocked) {
            await fetch(`${API_URL}/api/wrestling/events/${eventId}`, {
                method: 'PATCH', headers: authHeaders(),
                body: JSON.stringify({ is_locked: !currentlyLocked }),
            });
            loadWrestlingEvents();
        }

        async function deleteWrestlingEvent(eventId, title) {
            if (!confirm(`Delete "${title}" and all its data? This cannot be undone.`)) return;
            await fetch(`${API_URL}/api/wrestling/events/${eventId}`, { method: 'DELETE', headers: authHeaders() });
            loadWrestlingEvents();
        }

        async function notifyWrestlingEvent(eventId, title) {
            if (!confirm(`Send an email notification to all verified users about "${title}"?`)) return;
            try {
                const res = await fetch(`${API_URL}/api/wrestling/events/${eventId}/notify`, {
                    method: 'POST', headers: authHeaders()
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail || 'Failed');
                alert(`‚úÖ Notification sent to ${data.sent_to} user(s)!`);
            } catch (err) {
                alert(`‚ùå Could not send notification: ${err.message}`);
            }
        }

        // ‚îÄ‚îÄ Questions modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function openEventQuestions(eventId) {
            currentWrestlingEventId = eventId;
            const ev = wrestlingEvents.find(e => e.id === eventId);
            document.getElementById('w-questions-event-title').textContent = ev ? ev.title : '';
            document.getElementById('w-questions-modal').classList.add('show');
            await loadEventQuestions(eventId);
        }

        async function loadEventQuestions(eventId) {
            const container = document.getElementById('w-questions-list');
            container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">Loading‚Ä¶</div>';
            try {
                const res = await fetch(`${API_URL}/api/wrestling/events/${eventId}`, { headers: authHeaders() });
                const ev = await res.json();
                wrestlingQuestions = ev.questions || [];
                renderQuestionsList();
            } catch (err) {
                container.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
            }
        }

        function renderQuestionsList() {
            const container = document.getElementById('w-questions-list');
            if (!wrestlingQuestions.length) {
                container.innerHTML = '<div style="color:var(--text-muted);padding:12px;text-align:center;">No questions yet. Add one below.</div>';
                return;
            }
            container.innerHTML = wrestlingQuestions.map((q, i) => `
                <div style="display:flex;align-items:flex-start;gap:10px;padding:12px;border:1px solid var(--card-border);border-radius:8px;margin-bottom:8px;background:var(--card-bg);">
                    <div style="font-size:18px;min-width:28px;text-align:center;padding-top:2px;">${{short_answer:'‚úèÔ∏è',multiple_choice:'üîò',dropdown:'‚ñæ',checkbox:'‚òëÔ∏è'}[q.question_type] || '‚ùì'}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:600;font-size:13px;margin-bottom:4px;">${q.question_text}</div>
                        <div style="font-size:11px;color:var(--text-muted);">
                            ${q.question_type.replace('_', ' ')}
                            ${q.options && q.options.length ? ' ¬∑ ' + q.options.join(', ') : ''}
                            ${!q.counts_for_score ? ' ¬∑ <em>not scored</em>' : ''}
                            ${q.correct_answer !== undefined && q.correct_answer !== null ? ` ¬∑ ‚úì <strong>${Array.isArray(q.correct_answer) ? q.correct_answer.join(', ') : q.correct_answer}</strong>` : ''}
                        </div>
                    </div>
                    <div style="display:flex;gap:6px;flex-shrink:0;">
                        <button class="btn btn-sm btn-secondary" onclick="showEditQuestionModal(${i})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWrestlingQuestion(${q.id})">Del</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddQuestionForm() {
            editingQuestion = null;
            document.getElementById('w-q-modal-title').textContent = 'Add Question';
            document.getElementById('w-q-form').reset();
            document.getElementById('w-q-options-row').style.display = 'none';
            document.getElementById('w-q-alert').innerHTML = '';
            document.getElementById('w-q-modal').classList.add('show');
        }

        function showEditQuestionModal(idx) {
            const q = wrestlingQuestions[idx];
            editingQuestion = q;
            document.getElementById('w-q-modal-title').textContent = 'Edit Question';
            document.getElementById('w-q-text').value = q.question_text;
            document.getElementById('w-q-type').value = q.question_type;
            document.getElementById('w-q-scored').checked = q.counts_for_score;
            document.getElementById('w-q-sort').value = q.sort_order;
            const hasOptions = ['multiple_choice','dropdown','checkbox'].includes(q.question_type);
            document.getElementById('w-q-options-row').style.display = hasOptions ? '' : 'none';
            document.getElementById('w-q-options').value = q.options ? q.options.join('\n') : '';
            document.getElementById('w-q-alert').innerHTML = '';
            document.getElementById('w-q-modal').classList.add('show');
        }

        function onWQTypeChange() {
            const t = document.getElementById('w-q-type').value;
            document.getElementById('w-q-options-row').style.display = ['multiple_choice','dropdown','checkbox'].includes(t) ? '' : 'none';
        }

        async function saveWrestlingQuestion(e) {
            e.preventDefault();
            const type = document.getElementById('w-q-type').value;
            const optionsRaw = document.getElementById('w-q-options').value;
            const options = ['multiple_choice','dropdown','checkbox'].includes(type)
                ? optionsRaw.split('\n').map(s => s.trim()).filter(Boolean)
                : null;
            const data = {
                question_text:    document.getElementById('w-q-text').value.trim(),
                question_type:    type,
                options:          options,
                counts_for_score: document.getElementById('w-q-scored').checked,
                sort_order:       parseInt(document.getElementById('w-q-sort').value) || 0,
            };
            try {
                let res;
                if (editingQuestion) {
                    res = await fetch(`${API_URL}/api/wrestling/questions/${editingQuestion.id}`, {
                        method: 'PATCH', headers: authHeaders(), body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch(`${API_URL}/api/wrestling/events/${currentWrestlingEventId}/questions`, {
                        method: 'POST', headers: authHeaders(), body: JSON.stringify(data),
                    });
                }
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                closeModal('w-q-modal');
                loadEventQuestions(currentWrestlingEventId);
            } catch (err) {
                document.getElementById('w-q-alert').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
            }
        }

        async function deleteWrestlingQuestion(qId) {
            if (!confirm('Delete this question?')) return;
            await fetch(`${API_URL}/api/wrestling/questions/${qId}`, { method: 'DELETE', headers: authHeaders() });
            loadEventQuestions(currentWrestlingEventId);
        }

        // ‚îÄ‚îÄ Grade modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function openGradeModal(eventId) {
            currentWrestlingEventId = eventId;
            const ev = wrestlingEvents.find(e => e.id === eventId);
            document.getElementById('w-grade-event-title').textContent = ev ? ev.title : '';
            document.getElementById('w-grade-alert').innerHTML = '';
            document.getElementById('w-grade-modal').classList.add('show');
            const container = document.getElementById('w-grade-questions');
            container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">Loading‚Ä¶</div>';
            const res = await fetch(`${API_URL}/api/wrestling/events/${eventId}`, { headers: authHeaders() });
            const evData = await res.json();
            const qs = (evData.questions || []).filter(q => q.counts_for_score);
            if (!qs.length) {
                container.innerHTML = '<div style="color:var(--text-muted);">No scoreable questions.</div>';
                return;
            }
            container.innerHTML = qs.map(q => `
                <div style="margin-bottom:20px;padding:16px;border:1px solid var(--card-border);border-radius:8px;background:var(--card-bg);">
                    <div style="font-weight:600;margin-bottom:10px;font-size:14px;">${q.question_text}</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">${q.question_type.replace('_',' ')}</div>
                    ${q.correct_answer !== undefined && q.correct_answer !== null
                        ? `<div style="font-size:12px;color:var(--accent);margin-bottom:8px;">Current answer: ${Array.isArray(q.correct_answer) ? q.correct_answer.join(', ') : q.correct_answer}</div>`
                        : ''}
                    ${renderGradeInput(q)}
                </div>
            `).join('');
        }

        function renderGradeInput(q) {
            const fid = `grade-q-${q.id}`;
            if (q.question_type === 'short_answer' || q.question_type === 'dropdown' || q.question_type === 'multiple_choice') {
                if (q.options && q.options.length) {
                    return `<select id="${fid}" style="width:100%;padding:8px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:6px;color:var(--text-primary);font-size:13px;">
                        <option value="">-- select correct answer --</option>
                        ${q.options.map(o => `<option value="${o}" ${q.correct_answer === o ? 'selected' : ''}>${o}</option>`).join('')}
                    </select>`;
                }
                return `<input id="${fid}" type="text" placeholder="Correct answer‚Ä¶" value="${q.correct_answer || ''}"
                    style="width:100%;padding:8px;background:var(--input-bg);border:1px solid var(--input-border);border-radius:6px;color:var(--text-primary);font-size:13px;font-family:inherit;">`;
            }
            if (q.question_type === 'checkbox') {
                const currentCorrect = Array.isArray(q.correct_answer) ? q.correct_answer : [];
                return `<div>${(q.options || []).map(o => `
                    <label style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;font-size:13px;">
                        <input type="checkbox" name="${fid}" value="${o}" ${currentCorrect.includes(o) ? 'checked' : ''}> ${o}
                    </label>`).join('')}</div>`;
            }
            return '';
        }

        async function submitGrades(e) {
            e.preventDefault();
            const container = document.getElementById('w-grade-questions');
            const qDivs = container.querySelectorAll('[id^="grade-q-"]');
            const answers = [];
            // collect select/input answers
            container.querySelectorAll('select[id^="grade-q-"], input[type="text"][id^="grade-q-"]').forEach(el => {
                const qId = parseInt(el.id.replace('grade-q-', ''));
                if (!isNaN(qId)) answers.push({ question_id: qId, correct_answer: el.value.trim() });
            });
            // collect checkbox answers
            const checkboxGroups = {};
            container.querySelectorAll('input[type="checkbox"][name^="grade-q-"]').forEach(cb => {
                const qId = parseInt(cb.name.replace('grade-q-', ''));
                if (!checkboxGroups[qId]) checkboxGroups[qId] = [];
                if (cb.checked) checkboxGroups[qId].push(cb.value);
            });
            Object.entries(checkboxGroups).forEach(([qId, vals]) => {
                answers.push({ question_id: parseInt(qId), correct_answer: vals });
            });

            try {
                const res = await fetch(`${API_URL}/api/wrestling/events/${currentWrestlingEventId}/grade`, {
                    method: 'POST', headers: authHeaders(), body: JSON.stringify({ answers }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed');
                const result = await res.json();
                document.getElementById('w-grade-alert').innerHTML = `<div class="alert alert-success">‚úì ${result.message} (max ${result.max_score} pts)</div>`;
                loadWrestlingEvents();
            } catch (err) {
                document.getElementById('w-grade-alert').innerHTML = `<div class="alert alert-error">${err.message}</div>`;
            }
        }

        // ‚îÄ‚îÄ Submissions modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function openSubmissionsModal(eventId) {
            const ev = wrestlingEvents.find(e => e.id === eventId);
            document.getElementById('w-subs-event-title').textContent = ev ? ev.title : '';
            document.getElementById('w-subs-modal').classList.add('show');
            const container = document.getElementById('w-subs-list');
            container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">Loading‚Ä¶</div>';
            try {
                const res = await fetch(`${API_URL}/api/wrestling/events/${eventId}/submissions`, { headers: authHeaders() });
                const subs = await res.json();
                if (!subs.length) {
                    container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">No submissions yet.</div>';
                    return;
                }
                container.innerHTML = `<table class="table"><thead><tr><th>User</th><th>Score</th><th>%</th><th>Submitted</th></tr></thead><tbody>
                    ${subs.map((s, i) => {
                        const pct = s.max_score ? Math.round((s.score / s.max_score) * 100) : '‚Äî';
                        return `<tr>
                            <td><strong>#${i+1}</strong> ${s.username}</td>
                            <td>${s.score !== null ? s.score + ' / ' + s.max_score : 'Pending'}</td>
                            <td>${s.score !== null ? pct + '%' : '‚Äî'}</td>
                            <td style="font-size:12px;color:var(--text-muted);">${s.submitted_at ? new Date(s.submitted_at).toLocaleDateString() : '‚Äî'}</td>
                        </tr>`;
                    }).join('')}
                </tbody></table>`;
            } catch (err) {
                container.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
            }
        }
    </script>

    <!-- Wrestling: New/Edit Event Modal -->
    <div class="modal" id="w-event-modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3 id="w-event-modal-title">New Event</h3>
                <button class="modal-close" onclick="closeModal('w-event-modal')">√ó</button>
            </div>
            <div id="w-event-alert"></div>
            <form id="w-event-form" onsubmit="saveWrestlingEvent(event)">
                <div class="form-group">
                    <label class="form-label">Event Title *</label>
                    <input id="w-event-title" type="text" class="form-input" required placeholder="e.g. Royal Rumble 2025">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="w-event-description" class="form-input" rows="2" placeholder="Optional description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Poster / Banner URL</label>
                    <input id="w-event-image-url" type="url" class="form-input" placeholder="https://‚Ä¶">
                </div>
                <div class="form-group">
                    <label class="form-label">Event Date</label>
                    <input id="w-event-date" type="datetime-local" class="form-input">
                </div>
                <div class="form-group" id="w-event-notify-row">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                        <input type="checkbox" id="w-event-notify" style="width:16px;height:16px;">
                        <span>üìß Notify all verified users by email</span>
                    </label>
                    <p style="margin:4px 0 0 24px;font-size:0.82em;color:var(--text-muted);">
                        Sends a prediction invite email to every user who has verified their email address.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('w-event-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Wrestling: Questions Modal -->
    <div class="modal" id="w-questions-modal">
        <div class="modal-content" style="max-width:640px;max-height:85vh;overflow-y:auto;">
            <div class="modal-header">
                <h3>Questions ‚Äî <span id="w-questions-event-title" style="color:var(--accent);"></span></h3>
                <button class="modal-close" onclick="closeModal('w-questions-modal')">√ó</button>
            </div>
            <div id="w-questions-list" style="margin-bottom:16px;"></div>
            <button class="btn btn-primary" style="width:100%;" onclick="showAddQuestionForm()">+ Add Question</button>
        </div>
    </div>

    <!-- Wrestling: Add/Edit Question Modal -->
    <div class="modal" id="w-q-modal">
        <div class="modal-content" style="max-width:520px;">
            <div class="modal-header">
                <h3 id="w-q-modal-title">Add Question</h3>
                <button class="modal-close" onclick="closeModal('w-q-modal')">√ó</button>
            </div>
            <div id="w-q-alert"></div>
            <form id="w-q-form" onsubmit="saveWrestlingQuestion(event)">
                <div class="form-group">
                    <label class="form-label">Question *</label>
                    <textarea id="w-q-text" class="form-input" rows="2" required placeholder="e.g. Who wins the WWE Championship?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <select id="w-q-type" class="form-input" onchange="onWQTypeChange()" required>
                        <option value="short_answer">Short Answer</option>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="dropdown">Dropdown</option>
                        <option value="checkbox">Checkboxes (multi-select)</option>
                    </select>
                </div>
                <div class="form-group" id="w-q-options-row" style="display:none;">
                    <label class="form-label">Options (one per line)</label>
                    <textarea id="w-q-options" class="form-input" rows="5" placeholder="Cody Rhodes&#10;Roman Reigns&#10;Seth Rollins"></textarea>
                </div>
                <div style="display:flex;gap:16px;align-items:center;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Sort Order</label>
                        <input id="w-q-sort" type="number" class="form-input" value="0" min="0">
                    </div>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;padding-top:18px;">
                        <input id="w-q-scored" type="checkbox" checked> Counts for score
                    </label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('w-q-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Question</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Wrestling: Grade Modal -->
    <div class="modal" id="w-grade-modal">
        <div class="modal-content" style="max-width:600px;max-height:85vh;overflow-y:auto;">
            <div class="modal-header">
                <h3>Grade ‚Äî <span id="w-grade-event-title" style="color:var(--accent);"></span></h3>
                <button class="modal-close" onclick="closeModal('w-grade-modal')">√ó</button>
            </div>
            <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">
                Enter the correct answer for each question. Submissions will be scored automatically. You can re-grade as many times as needed.
            </p>
            <div id="w-grade-alert"></div>
            <form onsubmit="submitGrades(event)">
                <div id="w-grade-questions"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('w-grade-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Answers & Grade</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Wrestling: Submissions Modal -->
    <div class="modal" id="w-subs-modal">
        <div class="modal-content" style="max-width:560px;max-height:80vh;overflow-y:auto;">
            <div class="modal-header">
                <h3>Submissions ‚Äî <span id="w-subs-event-title" style="color:var(--accent);"></span></h3>
                <button class="modal-close" onclick="closeModal('w-subs-modal')">√ó</button>
            </div>
            <div id="w-subs-list"></div>
        </div>
    </div>
</body>
</html>
