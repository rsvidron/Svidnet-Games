<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrestling Predictions â€“ Svidhaus Arena</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }

        :root[data-theme="dark"] {
            --bg:#0f0f0f; --sidebar-bg:#1a1a1a; --card-bg:#1e1e1e;
            --card-border:#2a2a2a; --text-primary:#ffffff; --text-secondary:#888888;
            --text-muted:#555555; --accent:#22c55e; --accent-hover:#16a34a;
            --accent-dim:rgba(34,197,94,0.1); --danger:#ef4444;
            --input-bg:#2a2a2a; --input-border:#333333;
            --hover-bg:#252525; --divider:#2a2a2a; --modal-bg:#1a1a1a;
        }
        :root[data-theme="light"] {
            --bg:#f4f6f9; --sidebar-bg:#ffffff; --card-bg:#ffffff;
            --card-border:#e5e7eb; --text-primary:#111827; --text-secondary:#6b7280;
            --text-muted:#9ca3af; --accent:#16a34a; --accent-hover:#15803d;
            --accent-dim:rgba(22,163,74,0.08); --danger:#dc2626;
            --input-bg:#f9fafb; --input-border:#d1d5db;
            --hover-bg:#f3f4f6; --divider:#e5e7eb; --modal-bg:#ffffff;
        }

        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
               background:var(--bg);color:var(--text-primary);min-height:100vh;display:flex; }

        /* Sidebar */
        .sidebar { width:240px;background:var(--sidebar-bg);border-right:1px solid var(--divider);
                   display:flex;flex-direction:column;padding:24px 0;
                   position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform 0.3s; }
        .sidebar-logo { padding:0 24px 28px;border-bottom:1px solid var(--divider);margin-bottom:16px; }
        .sidebar-logo h1 { font-size:18px;font-weight:700; }
        .sidebar-logo span { font-size:12px;color:var(--text-secondary); }
        .sidebar-section { padding:0 12px;margin-bottom:8px; }
        .sidebar-label { font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;
                         letter-spacing:1px;padding:0 12px;margin-bottom:4px; }
        .sidebar-item { display:flex;align-items:center;gap:10px;padding:10px 12px;
                        border-radius:8px;color:var(--text-secondary);text-decoration:none;
                        font-size:14px;transition:all 0.15s;cursor:pointer;border:none;background:none;width:100%; }
        .sidebar-item:hover { background:var(--hover-bg);color:var(--text-primary); }
        .sidebar-item.active { background:var(--accent-dim);color:var(--accent); }
        .sidebar-item .icon { font-size:16px;width:20px;text-align:center; }
        .sidebar-bottom { margin-top:auto;padding:12px; }
        .mobile-menu-btn { display:none;background:none;border:none;font-size:22px;cursor:pointer;color:var(--text-primary); }

        /* Main */
        .main { margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh; }
        .topbar { height:60px;border-bottom:1px solid var(--divider);display:flex;align-items:center;
                  justify-content:space-between;padding:0 24px;background:var(--sidebar-bg);position:sticky;top:0;z-index:50; }
        .topbar h2 { font-size:16px;font-weight:600; }
        .theme-toggle { background:none;border:1px solid var(--divider);border-radius:8px;
                        padding:6px 10px;cursor:pointer;font-size:16px;color:var(--text-primary); }
        .content { padding:24px;flex:1; }

        /* Tabs */
        .page-tabs { display:flex;gap:4px;border-bottom:1px solid var(--divider);margin-bottom:24px; }
        .page-tab { padding:10px 18px;font-size:14px;font-weight:500;cursor:pointer;border:none;
                    background:none;color:var(--text-muted);border-bottom:2px solid transparent;transition:all 0.15s; }
        .page-tab.active { color:var(--accent);border-bottom-color:var(--accent); }
        .page-tab:hover { color:var(--text-primary); }
        .tab-panel { display:none; }
        .tab-panel.active { display:block; }

        /* Cards */
        .card { background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;padding:24px;margin-bottom:20px; }
        .card-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:16px; }
        .card-header h3 { font-size:16px;font-weight:600; }

        /* Event card */
        .event-card { background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;
                      overflow:hidden;margin-bottom:20px;transition:border-color 0.15s; }
        .event-card:hover { border-color:var(--accent); }
        .event-banner { width:100%;height:180px;object-fit:cover;display:block; }
        .event-banner-placeholder { height:180px;background:linear-gradient(135deg,#1a1a2e,#16213e);
                                    display:flex;align-items:center;justify-content:center;font-size:56px; }
        .event-body { padding:20px; }
        .event-meta { display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px; }
        .badge { display:inline-flex;align-items:center;padding:3px 10px;border-radius:99px;font-size:11px;font-weight:600; }
        .badge-open { background:rgba(34,197,94,0.15);color:#22c55e; }
        .badge-locked { background:rgba(239,68,68,0.15);color:#ef4444; }
        .badge-graded { background:rgba(59,130,246,0.15);color:#3b82f6; }
        .badge-done { background:rgba(34,197,94,0.15);color:#22c55e; }
        .event-title { font-size:20px;font-weight:700;margin-bottom:6px; }
        .event-desc { font-size:13px;color:var(--text-secondary);margin-bottom:12px; }
        .event-stats { display:flex;gap:16px;font-size:12px;color:var(--text-muted);margin-bottom:16px; }

        /* Buttons */
        .btn { padding:10px 18px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;
               border:none;transition:all 0.15s;font-family:inherit; }
        .btn-primary { background:var(--accent);color:#fff; }
        .btn-primary:hover { background:var(--accent-hover); }
        .btn-secondary { background:var(--input-bg);color:var(--text-primary);border:1px solid var(--input-border); }
        .btn-secondary:hover { background:var(--hover-bg); }
        .btn-sm { padding:6px 12px;font-size:13px; }

        /* Form */
        .form-group { margin-bottom:16px; }
        .form-label { display:block;font-size:13px;font-weight:500;color:var(--text-secondary);margin-bottom:6px; }
        .form-input { width:100%;padding:10px 14px;background:var(--input-bg);border:1px solid var(--input-border);
                      border-radius:8px;color:var(--text-primary);font-size:14px;font-family:inherit;outline:none;transition:border-color 0.15s; }
        .form-input:focus { border-color:var(--accent); }
        textarea.form-input { resize:vertical;min-height:80px; }

        /* Prediction form */
        .q-card { background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;
                  padding:20px;margin-bottom:16px; }
        .q-num { font-size:11px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px; }
        .q-text { font-size:15px;font-weight:600;margin-bottom:14px; }
        .q-option { display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;
                    border:1px solid var(--input-border);margin-bottom:8px;cursor:pointer;
                    transition:all 0.15s;font-size:14px; }
        .q-option:hover { border-color:var(--accent);background:var(--accent-dim); }
        .q-option input[type=radio], .q-option input[type=checkbox] { accent-color:var(--accent);width:16px;height:16px; }
        .q-option.selected { border-color:var(--accent);background:var(--accent-dim); }
        .q-correct { border-color:#22c55e !important;background:rgba(34,197,94,0.1) !important; }
        .q-wrong   { border-color:#ef4444 !important;background:rgba(239,68,68,0.08) !important; }
        .q-result-tag { font-size:11px;font-weight:700;margin-left:auto;padding:2px 8px;border-radius:99px; }
        .q-result-tag.correct { background:#22c55e;color:#fff; }
        .q-result-tag.wrong   { background:#ef4444;color:#fff; }
        .q-result-tag.partial { background:#f59e0b;color:#fff; }
        .q-score-row { font-size:12px;color:var(--text-muted);margin-top:8px; }

        /* Score display */
        .score-banner { background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(34,197,94,0.05));
                        border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:20px;
                        text-align:center;margin-bottom:24px; }
        .score-big { font-size:48px;font-weight:800;color:var(--accent); }
        .score-label { font-size:14px;color:var(--text-secondary);margin-top:4px; }

        /* Leaderboard */
        .lb-row { display:flex;align-items:center;gap:14px;padding:12px 16px;border-radius:10px;
                  border:1px solid var(--card-border);margin-bottom:8px;background:var(--card-bg); }
        .lb-rank { font-size:18px;font-weight:800;width:32px;text-align:center;flex-shrink:0; }
        .lb-avatar { width:36px;height:36px;border-radius:50%;background:var(--input-bg);
                     display:flex;align-items:center;justify-content:center;font-size:14px;
                     font-weight:700;color:var(--accent);flex-shrink:0;overflow:hidden; }
        .lb-avatar img { width:100%;height:100%;object-fit:cover; }
        .lb-name { font-weight:600;font-size:14px;flex:1; }
        .lb-score { font-size:14px;font-weight:700;color:var(--accent); }
        .lb-pct { font-size:12px;color:var(--text-muted);min-width:40px;text-align:right; }

        /* Stats */
        .stats-grid { display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;margin-bottom:24px; }
        .stat-card { background:var(--card-bg);border:1px solid var(--card-border);border-radius:12px;
                     padding:16px;text-align:center; }
        .stat-value { font-size:28px;font-weight:800;color:var(--accent); }
        .stat-label { font-size:12px;color:var(--text-secondary);margin-top:4px; }

        /* H2H */
        .h2h-bar { height:8px;border-radius:99px;background:var(--input-bg);overflow:hidden;margin:12px 0; }
        .h2h-bar-fill { height:100%;background:var(--accent);transition:width 0.5s; }
        .h2h-users { display:flex;justify-content:space-between;font-size:13px;font-weight:600; }

        /* Modal */
        .modal { display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;
                 align-items:center;justify-content:center;padding:16px; }
        .modal.show { display:flex; }
        .modal-content { background:var(--modal-bg);border-radius:16px;padding:28px;width:100%;
                         max-width:480px;max-height:90vh;overflow-y:auto; }
        .modal-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:20px; }
        .modal-header h3 { font-size:18px;font-weight:600; }
        .modal-close { background:none;border:none;font-size:22px;cursor:pointer;color:var(--text-muted);line-height:1; }
        .modal-close:hover { color:var(--text-primary); }
        .modal-footer { display:flex;gap:10px;justify-content:flex-end;margin-top:20px; }

        /* Alert */
        .alert { padding:11px 14px;border-radius:8px;margin-bottom:14px;font-size:13px; }
        .alert-success { background:rgba(34,197,94,0.1);color:#22c55e; }
        .alert-error { background:rgba(239,68,68,0.1);color:#ef4444; }

        /* Empty state */
        .empty-state { text-align:center;padding:48px 24px;color:var(--text-muted); }
        .empty-icon { font-size:48px;margin-bottom:16px; }

        /* Responsive */
        @media (max-width:768px) {
            .sidebar { transform:translateX(-100%); }
            .sidebar.open { transform:translateX(0); }
            .main { margin-left:0; }
            .mobile-menu-btn { display:block; }
            .stats-grid { grid-template-columns:repeat(2,1fr); }
            .event-banner, .event-banner-placeholder { height:130px; }
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <h1>Svidhaus Arena</h1>
            <span>Gaming Hub</span>
        </div>
        <div class="sidebar-section">
            <div class="sidebar-label">Menu</div>
            <a href="/" class="sidebar-item"><span class="icon">âŠ</span> Dashboard</a>
            <a href="/profile" class="sidebar-item"><span class="icon">ğŸ‘¤</span> Profile</a>
            <a href="/links" class="sidebar-item"><span class="icon">ğŸ”—</span> Links</a>
            <div id="admin-nav-btn" style="display:none;">
                <a href="/admin" class="sidebar-item"><span class="icon">âš™ï¸</span> Admin</a>
            </div>
        </div>
        <div class="sidebar-section" style="margin-top:12px;">
            <div class="sidebar-label">Games</div>
            <a href="/trivia" class="sidebar-item"><span class="icon">ğŸ¤“</span> Trivia</a>
            <a href="/wordle" class="sidebar-item"><span class="icon">ğŸŸ©</span> Wordle</a>
            <a href="/sportsbook" class="sidebar-item"><span class="icon">ğŸˆ</span> Sportsbook</a>
            <a href="/movies" class="sidebar-item"><span class="icon">ğŸ¬</span> Movies &amp; TV</a>
            <a href="/wrestling" class="sidebar-item active"><span class="icon">ğŸ¤¼</span> Wrestling</a>
        </div>
        <div class="sidebar-bottom">
            <button class="sidebar-item" onclick="logout()" style="color:var(--danger);">
                <span class="icon">â†©</span> Logout
            </button>
        </div>
    </aside>

    <div class="main">
        <div class="topbar">
            <div style="display:flex;align-items:center;gap:12px;">
                <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
                <h2>ğŸ¤¼ Wrestling Predictions</h2>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">â˜€ï¸</button>
                <span id="topbar-user" style="font-size:13px;color:var(--text-secondary);"></span>
            </div>
        </div>

        <div class="content">
            <div class="page-tabs">
                <button class="page-tab active" onclick="switchTab('events', this)">Events</button>
                <button class="page-tab" onclick="switchTab('leaderboard', this)">Leaderboard</button>
                <button class="page-tab" onclick="switchTab('mystats', this)">My Stats</button>
                <button class="page-tab" onclick="switchTab('h2h', this)">Head to Head</button>
            </div>

            <!-- Events Tab -->
            <div class="tab-panel active" id="tab-events">
                <div id="events-list"></div>
            </div>

            <!-- Leaderboard Tab -->
            <div class="tab-panel" id="tab-leaderboard">
                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        <h3>Overall Leaderboard</h3>
                        <span style="font-size:12px;color:var(--text-muted);">All-time across all events</span>
                    </div>
                    <div id="lb-overall"></div>
                </div>
                <div class="card" id="lb-event-card" style="display:none;">
                    <div class="card-header">
                        <h3 id="lb-event-title">Event Leaderboard</h3>
                        <select id="lb-event-select" class="form-input" style="max-width:220px;padding:6px 10px;" onchange="loadEventLeaderboard()">
                            <option value="">Select eventâ€¦</option>
                        </select>
                    </div>
                    <div id="lb-event-list"></div>
                </div>
            </div>

            <!-- My Stats Tab -->
            <div class="tab-panel" id="tab-mystats">
                <div class="stats-grid" id="my-stats-grid"></div>
                <div class="card">
                    <div class="card-header"><h3>Per-Event History</h3></div>
                    <div id="my-event-history"></div>
                </div>
            </div>

            <!-- H2H Tab -->
            <div class="tab-panel" id="tab-h2h">
                <div class="card">
                    <div class="card-header"><h3>Head to Head</h3></div>
                    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Compare your record vs another user.</p>
                    <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:20px;">
                        <div style="flex:1;min-width:180px;">
                            <div class="form-label">Compare against</div>
                            <input id="h2h-search" type="text" class="form-input" placeholder="Enter usernameâ€¦" oninput="onH2HSearch()">
                            <div id="h2h-suggestions" style="position:relative;"></div>
                        </div>
                        <button class="btn btn-primary" onclick="loadH2H()">Compare</button>
                    </div>
                    <div id="h2h-result"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prediction form modal -->
    <div class="modal" id="predict-modal">
        <div class="modal-content" style="max-width:640px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header">
                <h3 id="predict-modal-title">Submit Predictions</h3>
                <button class="modal-close" onclick="closeModal('predict-modal')">Ã—</button>
            </div>
            <div id="predict-alert"></div>
            <div id="predict-questions"></div>
            <div class="modal-footer" id="predict-footer">
                <button class="btn btn-secondary" onclick="closeModal('predict-modal')">Cancel</button>
                <button class="btn btn-primary" id="predict-submit-btn" onclick="submitPredictions()">Submit Predictions</button>
            </div>
        </div>
    </div>

    <!-- Results modal -->
    <div class="modal" id="results-modal">
        <div class="modal-content" style="max-width:640px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header">
                <h3 id="results-modal-title">Your Results</h3>
                <button class="modal-close" onclick="closeModal('results-modal')">Ã—</button>
            </div>
            <div id="results-content"></div>
        </div>
    </div>

    <script>
        const API = '';
        let currentUser = null;
        let allEvents   = [];
        let currentEventData = null;
        let h2hSelectedUserId = null;
        let allUsersCache = [];

        // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getTheme() { return localStorage.getItem('theme') || 'dark'; }
        function applyTheme(t) {
            document.documentElement.setAttribute('data-theme', t);
            document.getElementById('theme-btn').textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        }
        function toggleTheme() {
            const n = getTheme() === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', n);
            applyTheme(n);
        }
        applyTheme(getTheme());

        // â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getToken() { return localStorage.getItem('access_token') || localStorage.getItem('token'); }
        function getUser()  { try { return JSON.parse(localStorage.getItem('user')); } catch { return null; } }
        function authHeaders() { return { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' }; }
        function isAdmin(u) { return u && u.role === 'admin'; }
        function logout() {
            localStorage.removeItem('access_token'); localStorage.removeItem('token'); localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            currentUser = getUser();
            if (!currentUser) { window.location.href = '/login'; return; }
            document.getElementById('topbar-user').textContent = currentUser.username;
            if (isAdmin(currentUser)) document.getElementById('admin-nav-btn').style.display = '';
            loadEvents();
        });

        // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function switchTab(tab, el) {
            document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            if (tab === 'leaderboard') loadLeaderboards();
            if (tab === 'mystats')     loadMyStats();
            if (tab === 'h2h')         loadH2HUsers();
        }

        // â”€â”€ Events tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadEvents() {
            const container = document.getElementById('events-list');
            container.innerHTML = '<div style="color:var(--text-muted);padding:24px;">Loading eventsâ€¦</div>';
            try {
                const res = await fetch(`${API}/api/wrestling/events`, { headers: authHeaders() });
                allEvents = await res.json();
                if (!allEvents.length) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ¤¼</div><p>No events yet. Check back soon!</p></div>';
                    return;
                }
                container.innerHTML = allEvents.map(ev => renderEventCard(ev)).join('');
            } catch (e) {
                container.innerHTML = `<div class="alert alert-error">Failed to load events: ${e.message}</div>`;
            }
        }

        function renderEventCard(ev) {
            const locked  = ev.is_locked;
            const graded  = ev.is_graded;
            const submitted = ev.user_submitted;
            const dateStr = ev.event_date ? new Date(ev.event_date).toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }) : '';

            let actionBtn = '';
            if (graded && submitted) {
                actionBtn = `<button class="btn btn-primary" onclick="openResults(${ev.id})">View My Results</button>`;
            } else if (!locked && !submitted) {
                actionBtn = `<button class="btn btn-primary" onclick="openPredictForm(${ev.id})">Make Predictions</button>`;
            } else if (!locked && submitted) {
                actionBtn = `<button class="btn btn-secondary" onclick="openPredictForm(${ev.id})">Edit Predictions</button>`;
            } else {
                actionBtn = `<button class="btn btn-secondary" disabled style="opacity:0.5;cursor:not-allowed;">ğŸ”’ Locked</button>`;
            }

            return `<div class="event-card">
                ${ev.image_url
                    ? `<img class="event-banner" src="${ev.image_url}" alt="${ev.title}">`
                    : `<div class="event-banner-placeholder">ğŸ¤¼</div>`}
                <div class="event-body">
                    <div class="event-meta">
                        ${graded  ? '<span class="badge badge-graded">âœ“ Graded</span>' : ''}
                        ${locked && !graded ? '<span class="badge badge-locked">ğŸ”’ Locked</span>' : ''}
                        ${!locked ? '<span class="badge badge-open">Open</span>' : ''}
                        ${submitted ? '<span class="badge badge-done">Submitted</span>' : ''}
                    </div>
                    <div class="event-title">${ev.title}</div>
                    ${ev.description ? `<div class="event-desc">${ev.description}</div>` : ''}
                    <div class="event-stats">
                        ${dateStr ? `<span>ğŸ“… ${dateStr}</span>` : ''}
                        <span>${ev.question_count} question${ev.question_count !== 1 ? 's' : ''}</span>
                        ${ev.user_score !== null ? `<span>ğŸ† Your score: <strong>${ev.user_score}</strong></span>` : ''}
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        ${actionBtn}
                        ${graded ? `<button class="btn btn-secondary" onclick="openEventLb(${ev.id}, '${ev.title.replace(/'/g,"\\'")}')">View Leaderboard</button>` : ''}
                    </div>
                </div>
            </div>`;
        }

        // â”€â”€ Predict form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function openPredictForm(eventId) {
            document.getElementById('predict-alert').innerHTML = '';
            document.getElementById('predict-questions').innerHTML = '<div style="color:var(--text-muted);padding:16px;">Loadingâ€¦</div>';
            document.getElementById('predict-modal').classList.add('show');
            try {
                const res = await fetch(`${API}/api/wrestling/events/${eventId}`, { headers: authHeaders() });
                currentEventData = await res.json();
                document.getElementById('predict-modal-title').textContent = currentEventData.title;
                renderPredictForm(currentEventData);
            } catch (e) {
                document.getElementById('predict-questions').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        function renderPredictForm(ev) {
            const sub = ev.user_submission;
            const existingAnswers = sub ? sub.answers : {};
            const qs = ev.questions || [];

            document.getElementById('predict-questions').innerHTML = qs.map((q, i) => {
                const prev = existingAnswers[q.id];
                const prevVal = prev ? prev.answer_value : null;
                return `<div class="q-card">
                    <div class="q-num">Question ${i+1}${!q.counts_for_score ? ' Â· Not scored' : ''}</div>
                    <div class="q-text">${q.question_text}</div>
                    ${renderQuestionInput(q, prevVal)}
                </div>`;
            }).join('');

            // Pre-select radio/checkbox
            qs.forEach(q => {
                const prev = existingAnswers[q.id];
                if (!prev) return;
                if (q.question_type === 'multiple_choice') {
                    const radio = document.querySelector(`input[name="q_${q.id}"][value="${CSS.escape(prev.answer_value)}"]`);
                    if (radio) { radio.checked = true; radio.closest('.q-option').classList.add('selected'); }
                }
                if (q.question_type === 'checkbox' && Array.isArray(prev.answer_value)) {
                    prev.answer_value.forEach(v => {
                        const cb = document.querySelector(`input[name="q_${q.id}"][value="${CSS.escape(v)}"]`);
                        if (cb) { cb.checked = true; cb.closest('.q-option').classList.add('selected'); }
                    });
                }
            });
        }

        function renderQuestionInput(q, prevVal) {
            if (q.question_type === 'short_answer') {
                return `<input type="text" class="form-input" id="q_${q.id}" placeholder="Your answerâ€¦" value="${prevVal || ''}">`;
            }
            if (q.question_type === 'dropdown') {
                return `<select class="form-input" id="q_${q.id}">
                    <option value="">-- Select --</option>
                    ${(q.options || []).map(o => `<option value="${o}" ${prevVal === o ? 'selected' : ''}>${o}</option>`).join('')}
                </select>`;
            }
            if (q.question_type === 'multiple_choice') {
                return (q.options || []).map(o => `
                    <label class="q-option" onclick="selectRadio(this)">
                        <input type="radio" name="q_${q.id}" value="${o}" style="display:none;"> ${o}
                    </label>`).join('');
            }
            if (q.question_type === 'checkbox') {
                return (q.options || []).map(o => `
                    <label class="q-option" onclick="toggleCheck(this)">
                        <input type="checkbox" name="q_${q.id}" value="${o}" style="display:none;"> ${o}
                    </label>`).join('');
            }
            return '';
        }

        function selectRadio(label) {
            const radio = label.querySelector('input[type=radio]');
            const name  = radio.name;
            document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                r.closest('.q-option').classList.remove('selected');
            });
            radio.checked = true;
            label.classList.add('selected');
        }

        function toggleCheck(label) {
            const cb = label.querySelector('input[type=checkbox]');
            cb.checked = !cb.checked;
            label.classList.toggle('selected', cb.checked);
        }

        async function submitPredictions() {
            const ev = currentEventData;
            if (!ev) return;
            const answers = [];
            for (const q of ev.questions) {
                let val = null;
                if (q.question_type === 'short_answer') {
                    val = document.getElementById(`q_${q.id}`)?.value?.trim() || null;
                } else if (q.question_type === 'dropdown') {
                    val = document.getElementById(`q_${q.id}`)?.value || null;
                } else if (q.question_type === 'multiple_choice') {
                    const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
                    val = checked ? checked.value : null;
                } else if (q.question_type === 'checkbox') {
                    val = [...document.querySelectorAll(`input[name="q_${q.id}"]:checked`)].map(c => c.value);
                }
                answers.push({ question_id: q.id, answer_value: val });
            }
            try {
                const res = await fetch(`${API}/api/wrestling/events/${ev.id}/submit`, {
                    method: 'POST', headers: authHeaders(), body: JSON.stringify({ answers }),
                });
                if (!res.ok) throw new Error((await res.json()).detail || 'Failed to submit');
                closeModal('predict-modal');
                loadEvents();
                document.getElementById('predict-alert').innerHTML = '';
            } catch (e) {
                document.getElementById('predict-alert').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        // â”€â”€ Results modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function openResults(eventId) {
            document.getElementById('results-modal').classList.add('show');
            document.getElementById('results-content').innerHTML = '<div style="color:var(--text-muted);padding:16px;">Loadingâ€¦</div>';
            try {
                const res = await fetch(`${API}/api/wrestling/events/${eventId}`, { headers: authHeaders() });
                const ev = await res.json();
                document.getElementById('results-modal-title').textContent = ev.title + ' â€” Results';
                const sub = ev.user_submission;
                const qs  = ev.questions || [];
                if (!sub) {
                    document.getElementById('results-content').innerHTML = '<div class="alert alert-error">No submission found.</div>';
                    return;
                }
                const pct = sub.max_score ? Math.round((sub.score / sub.max_score) * 100) : 0;
                let html = `<div class="score-banner">
                    <div class="score-big">${sub.score} / ${sub.max_score}</div>
                    <div class="score-label">${pct}% correct</div>
                </div>`;
                html += qs.map((q, i) => {
                    const ans = sub.answers[q.id];
                    if (!ans) return '';
                    const correct   = ans.is_correct;
                    const partial   = ans.points_earned > 0 && ans.points_earned < 1;
                    const userVal   = Array.isArray(ans.answer_value) ? ans.answer_value.join(', ') : (ans.answer_value || 'â€”');
                    const correctVal = q.correct_answer !== undefined && q.correct_answer !== null
                        ? (Array.isArray(q.correct_answer) ? q.correct_answer.join(', ') : q.correct_answer)
                        : null;
                    const tag = !q.counts_for_score ? '' :
                        correct  ? '<span class="q-result-tag correct">âœ“ Correct</span>' :
                        partial  ? `<span class="q-result-tag partial">~ ${ans.points_earned} pts</span>` :
                                   '<span class="q-result-tag wrong">âœ— Wrong</span>';
                    const rowClass = !q.counts_for_score ? '' : correct ? 'q-correct' : partial ? '' : 'q-wrong';
                    return `<div class="q-card ${rowClass}">
                        <div class="q-num" style="display:flex;justify-content:space-between;align-items:center;">
                            <span>Question ${i+1}</span>${tag}
                        </div>
                        <div class="q-text">${q.question_text}</div>
                        <div style="font-size:13px;margin-top:6px;">
                            <span style="color:var(--text-muted);">Your answer: </span><strong>${userVal}</strong>
                        </div>
                        ${correctVal ? `<div style="font-size:13px;margin-top:4px;"><span style="color:var(--text-muted);">Correct: </span><strong style="color:var(--accent);">${correctVal}</strong></div>` : ''}
                    </div>`;
                }).join('');
                document.getElementById('results-content').innerHTML = html;
            } catch (e) {
                document.getElementById('results-content').innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        // â”€â”€ Quick event leaderboard from event card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openEventLb(eventId, title) {
            switchTab('leaderboard', document.querySelectorAll('.page-tab')[1]);
            setTimeout(async () => {
                const sel = document.getElementById('lb-event-select');
                sel.value = eventId;
                document.getElementById('lb-event-title').textContent = title + ' Leaderboard';
                await loadEventLeaderboard();
            }, 50);
        }

        // â”€â”€ Leaderboard tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadLeaderboards() {
            // overall
            const overall = document.getElementById('lb-overall');
            overall.innerHTML = '<div style="color:var(--text-muted);padding:12px;">Loadingâ€¦</div>';
            try {
                const res = await fetch(`${API}/api/wrestling/leaderboard/overall`, { headers: authHeaders() });
                const rows = await res.json();
                renderLbRows(overall, rows, 'overall');
            } catch (e) {
                overall.innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }

            // populate event select
            const sel = document.getElementById('lb-event-select');
            const graded = allEvents.filter(e => e.is_graded);
            if (graded.length) {
                sel.innerHTML = '<option value="">Select eventâ€¦</option>' +
                    graded.map(e => `<option value="${e.id}">${e.title}</option>`).join('');
                document.getElementById('lb-event-card').style.display = '';
            }
        }

        function renderLbRows(container, rows, type) {
            if (!rows.length) {
                container.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">No data yet.</div>';
                return;
            }
            const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
            container.innerHTML = rows.map((r, i) => {
                const score = type === 'overall'
                    ? `${r.total_pts} pts / ${r.total_max}`
                    : `${r.score} / ${r.max_score}`;
                const pct = type === 'overall' ? r.pct : r.pct;
                const isMe = currentUser && r.username === currentUser.username;
                return `<div class="lb-row" ${isMe ? 'style="border-color:var(--accent);"' : ''}>
                    <div class="lb-rank">${medals[i] || (i+1)}</div>
                    <div class="lb-avatar">${r.avatar_url ? `<img src="${r.avatar_url}">` : r.username[0].toUpperCase()}</div>
                    <div class="lb-name">${r.username}${isMe ? ' <span style="font-size:11px;color:var(--accent);">(you)</span>' : ''}</div>
                    <div class="lb-score">${score}</div>
                    <div class="lb-pct">${pct}%</div>
                </div>`;
            }).join('');
        }

        async function loadEventLeaderboard() {
            const eventId = document.getElementById('lb-event-select').value;
            if (!eventId) return;
            const ev = allEvents.find(e => e.id == eventId);
            document.getElementById('lb-event-title').textContent = (ev ? ev.title : 'Event') + ' Leaderboard';
            const container = document.getElementById('lb-event-list');
            container.innerHTML = '<div style="color:var(--text-muted);padding:12px;">Loadingâ€¦</div>';
            try {
                const res = await fetch(`${API}/api/wrestling/leaderboard/event/${eventId}`, { headers: authHeaders() });
                const rows = await res.json();
                renderLbRows(container, rows, 'event');
            } catch (e) {
                container.innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        // â”€â”€ My Stats tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadMyStats() {
            const grid    = document.getElementById('my-stats-grid');
            const history = document.getElementById('my-event-history');
            grid.innerHTML = '<div style="color:var(--text-muted);">Loadingâ€¦</div>';
            history.innerHTML = '';
            try {
                const res = await fetch(`${API}/api/wrestling/stats/me/summary`, { headers: authHeaders() });
                const stats = await res.json();
                grid.innerHTML = `
                    <div class="stat-card"><div class="stat-value">${stats.events_played}</div><div class="stat-label">Events Entered</div></div>
                    <div class="stat-card"><div class="stat-value">${stats.events_graded}</div><div class="stat-label">Events Graded</div></div>
                    <div class="stat-card"><div class="stat-value">${stats.total_pts}</div><div class="stat-label">Total Points</div></div>
                    <div class="stat-card"><div class="stat-value">${stats.overall_pct}%</div><div class="stat-label">Overall %</div></div>
                `;
                if (!stats.per_event.length) {
                    history.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px;">No event history yet.</div>';
                    return;
                }
                history.innerHTML = stats.per_event.map(e => {
                    const pct = e.pct !== null ? e.pct + '%' : 'Pending';
                    const score = e.score !== null ? `${e.score} / ${e.max_score}` : 'Pending';
                    const dateStr = e.event_date ? new Date(e.event_date).toLocaleDateString() : '';
                    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-radius:10px;border:1px solid var(--card-border);margin-bottom:8px;background:var(--card-bg);">
                        <div>
                            <div style="font-weight:600;font-size:14px;">${e.event_title}</div>
                            ${dateStr ? `<div style="font-size:12px;color:var(--text-muted);">${dateStr}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700;color:var(--accent);">${score}</div>
                            <div style="font-size:12px;color:var(--text-muted);">${pct}</div>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                grid.innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        // â”€â”€ H2H tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadH2HUsers() {
            // pre-fetch user list for autocomplete
            try {
                const res = await fetch(`${API}/api/wrestling/leaderboard/overall`, { headers: authHeaders() });
                allUsersCache = await res.json();
            } catch {}
        }

        function onH2HSearch() {
            const q = document.getElementById('h2h-search').value.trim().toLowerCase();
            const box = document.getElementById('h2h-suggestions');
            if (!q) { box.innerHTML = ''; return; }
            const matches = allUsersCache.filter(u =>
                u.username.toLowerCase().includes(q) && u.username !== currentUser?.username
            ).slice(0, 6);
            if (!matches.length) { box.innerHTML = ''; return; }
            box.innerHTML = `<div style="position:absolute;z-index:50;width:100%;background:var(--modal-bg);border:1px solid var(--card-border);border-radius:8px;margin-top:4px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,0.3);">
                ${matches.map(u => `<div onclick="selectH2HUser(${u.user_id}, '${u.username}')"
                    style="padding:10px 14px;cursor:pointer;font-size:13px;"
                    onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background=''">
                    ${u.username}
                </div>`).join('')}
            </div>`;
        }

        function selectH2HUser(userId, username) {
            h2hSelectedUserId = userId;
            document.getElementById('h2h-search').value = username;
            document.getElementById('h2h-suggestions').innerHTML = '';
        }

        async function loadH2H() {
            if (!h2hSelectedUserId) { alert('Select a user first.'); return; }
            const container = document.getElementById('h2h-result');
            container.innerHTML = '<div style="color:var(--text-muted);">Loadingâ€¦</div>';
            try {
                const res = await fetch(`${API}/api/wrestling/h2h/${currentUser.id}/${h2hSelectedUserId}`, { headers: authHeaders() });
                const data = await res.json();
                const total = data.wins_a + data.wins_b + data.ties;
                const pctA  = total ? Math.round((data.wins_a / total) * 100) : 50;

                let html = `
                    <div class="h2h-users">
                        <span>${data.user_a.username} <strong style="color:var(--accent);">${data.wins_a}W</strong></span>
                        <span style="color:var(--text-muted);">${data.ties} Tie${data.ties !== 1 ? 's' : ''}</span>
                        <span><strong style="color:#3b82f6;">${data.wins_b}W</strong> ${data.user_b.username}</span>
                    </div>
                    <div class="h2h-bar"><div class="h2h-bar-fill" style="width:${pctA}%"></div></div>
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:20px;text-align:center;">${data.shared_events} shared event${data.shared_events !== 1 ? 's' : ''}</div>
                `;
                if (data.events.length) {
                    html += data.events.map(ev => {
                        const winner = ev.winner === currentUser.id ? 'ğŸ† You won' :
                                       ev.winner === h2hSelectedUserId ? 'ğŸ’€ They won' :
                                       ev.graded ? 'ğŸ¤ Tie' : 'Pending';
                        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-radius:10px;border:1px solid var(--card-border);margin-bottom:8px;background:var(--card-bg);">
                            <div>
                                <div style="font-weight:600;font-size:14px;">${ev.event_title}</div>
                                ${ev.event_date ? `<div style="font-size:12px;color:var(--text-muted);">${new Date(ev.event_date).toLocaleDateString()}</div>` : ''}
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:13px;">${ev.graded ? `${ev.score_a} vs ${ev.score_b}` : 'Not graded'}</div>
                                <div style="font-size:12px;color:var(--text-muted);">${winner}</div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    html += '<div style="color:var(--text-muted);text-align:center;padding:16px;">No shared events yet.</div>';
                }
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `<div class="alert alert-error">${e.message}</div>`;
            }
        }

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
    </script>
</body>
</html>
